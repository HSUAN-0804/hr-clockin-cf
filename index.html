<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>H.R燈藝｜員工打卡</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg:#0b0c10;--text:#f5f5f7;--muted:#b7bbc3;--border:rgba(255,255,255,.08);
      --radius:18px;--gold:rgba(255,215,0,.75);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      background:radial-gradient(1200px 800px at 50% -20%, rgba(255,215,0,.10), transparent 50%),
                 radial-gradient(900px 600px at 0% 0%, rgba(59,130,246,.10), transparent 55%),
                 var(--bg);color:var(--text)}
    .wrap{max-width:640px;margin:0 auto;padding:18px 14px 28px}
    .brand{font-weight:800;letter-spacing:.5px;font-size:14px;color:var(--gold)}
    .title{margin:6px 0 12px;font-size:26px;font-weight:900}
    .tabs{display:flex;gap:10px;margin:10px 0 12px}
    .tab{flex:1;border:1px solid var(--border);background:rgba(255,255,255,.04);color:rgba(255,255,255,.85);
      padding:10px 12px;border-radius:14px;font-weight:900;text-align:center;cursor:pointer;user-select:none}
    .tab.active{border-color:rgba(255,215,0,.25);background:rgba(255,215,0,.10);color:#fff}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 16px 42px rgba(0,0,0,.35)}
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--border);
      background:rgba(0,0,0,.25);color:var(--muted);font-size:13px}
    .clock{font-size:44px;font-weight:900;letter-spacing:1px;margin:10px 0 8px}
    .sub{color:var(--muted);font-size:13px;line-height:1.4}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px}
    button{width:100%;border:none;border-radius:16px;padding:14px 14px;font-size:18px;font-weight:900;color:var(--text);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));border:1px solid var(--border);cursor:pointer}
    button:active{transform:scale(.99)}
    button[disabled]{opacity:.55;cursor:not-allowed}
    .status{margin-top:12px;padding:12px 12px;border-radius:14px;border:1px solid var(--border);
      background:rgba(0,0,0,.22);font-size:14px;line-height:1.4;color:var(--muted);white-space:pre-line}
    .status.ok{border-color:rgba(34,197,94,.35);color:rgba(220,252,231,.95)}
    .status.bad{border-color:rgba(239,68,68,.38);color:rgba(254,226,226,.95)}
    .status.warn{border-color:rgba(245,158,11,.35);color:rgba(255,237,213,.95)}
    .kv{display:grid;grid-template-columns:110px 1fr;gap:8px;margin-top:10px}
    .kv div{font-size:13px;color:var(--muted)}
    .kv b{color:var(--text);font-weight:800;word-break:break-all}
    .mini{margin-top:12px;color:rgba(255,255,255,.55);font-size:12px}
    .softbtn{margin-top:10px;width:100%;border-radius:14px;padding:12px;font-size:14px;font-weight:900;
      background:rgba(255,215,0,.12);border:1px solid rgba(255,215,0,.25);color:rgba(255,255,255,.92);
      cursor:pointer;display:none}
    .closebtn{margin-top:10px;width:100%;border-radius:14px;padding:12px;font-size:14px;font-weight:900;
      background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.18);color:rgba(255,255,255,.96);
      cursor:pointer;display:none}
    .hidden{display:none}

    /* schedule */
    .scheduleTop{display:flex;gap:10px;align-items:center;margin:8px 0 12px}
    .monthBox{flex:1;border:1px solid var(--border);border-radius:14px;background:rgba(255,255,255,.04);
      padding:10px 12px;color:#fff;font-weight:900;display:flex;justify-content:space-between;align-items:center}
    .monthBtn{flex:0 0 auto;padding:10px 12px;border-radius:14px;font-weight:900}
    .list{margin-top:10px;display:flex;flex-direction:column;gap:10px}
    .item{border:1px solid var(--border);border-radius:14px;padding:12px;background:rgba(0,0,0,.22);
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .item .d{font-weight:900}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted)}
    .badge.work{border-color:rgba(34,197,94,.35);color:rgba(220,252,231,.95)}
    .badge.off{border-color:rgba(239,68,68,.35);color:rgba(254,226,226,.95)}
    .seg{color:#fff;font-weight:800}
    .note{color:rgba(255,255,255,.60);font-size:12px;margin-top:4px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="brand">員工專用</div>
    <div class="title">H.R燈藝｜打卡</div>

    <div class="tabs">
      <div class="tab active" id="tabClock">打卡</div>
      <div class="tab" id="tabSchedule">本月班表</div>
    </div>

    <div class="card" id="panelClock">
      <div class="row">
        <div class="pill" id="pillLogin">尚未登入</div>
        <div class="pill" id="pillGps">定位未取得</div>
        <div class="pill" id="pillState">狀態：讀取中</div>
      </div>

      <div class="clock" id="clock">--:--</div>
      <div class="sub" id="hello">請稍候…</div>

      <div class="kv">
        <div>距離店面</div><div><b id="distText">--</b></div>
        <div>我的LINE ID</div><div><b id="uidText">--</b></div>
        <div>LIFF環境</div><div><b id="clientText">--</b></div>
      </div>

      <button class="softbtn" id="btnCopyId">一鍵複製我的LINE ID</button>
      <button class="closebtn" id="btnClose">關閉視窗（返回LINE）</button>

      <div class="grid">
        <button id="btnIn">上班打卡</button>
        <button id="btnOut">下班打卡</button>
      </div>

      <div class="status" id="statusBox">準備中…</div>
      <div class="mini">打卡成功會由「員工端」送出 Flex（不扣官方帳號則數）。</div>
    </div>

    <div class="card hidden" id="panelSchedule">
      <div class="scheduleTop">
        <div class="monthBox">
          <span>月份</span>
          <span id="monthLabel">----</span>
        </div>
        <button class="monthBtn" id="btnPrev">上月</button>
        <button class="monthBtn" id="btnNext">下月</button>
      </div>

      <div class="status" id="scheduleStatus">尚未載入…</div>
      <div class="list" id="scheduleList"></div>
      <div class="mini">班表來源：shift_overrides ＞ shift_month（PT）＞ shift_templates（FT）。</div>
    </div>
  </div>

<script>
  const LIFF_ID = "2008810311-jmqyUaTN";
  const LIFF_HOME_URL = `https://liff.line.me/${LIFF_ID}`;

  const el = (id)=>document.getElementById(id);
  const tabClock = el('tabClock'), tabSchedule = el('tabSchedule');
  const panelClock = el('panelClock'), panelSchedule = el('panelSchedule');

  const pillLogin = el('pillLogin');
  const pillGps = el('pillGps');
  const pillState = el('pillState');
  const helloEl = el('hello');
  const statusBox = el('statusBox');
  const distText = el('distText');
  const uidText = el('uidText');
  const clientText = el('clientText');
  const btnCopyId = el('btnCopyId');
  const btnClose = el('btnClose');
  const clockEl = el('clock');

  const monthLabel = el('monthLabel');
  const btnPrev = el('btnPrev');
  const btnNext = el('btnNext');
  const scheduleStatus = el('scheduleStatus');
  const scheduleList = el('scheduleList');

  const btnIn = el('btnIn');
  const btnOut = el('btnOut');

  let profile = null;
  let lastPos = null;

  // 狀態：EMPTY/OFF/IN/UNKNOWN（EMPTY與OFF都視為可IN）
  let currentState = 'UNKNOWN';

  function setTab(which){
    if(which==='clock'){
      tabClock.classList.add('active'); tabSchedule.classList.remove('active');
      panelClock.classList.remove('hidden'); panelSchedule.classList.add('hidden');
    }else{
      tabSchedule.classList.add('active'); tabClock.classList.remove('active');
      panelSchedule.classList.remove('hidden'); panelClock.classList.add('hidden');
      if(profile && profile.userId) loadSchedule(currentMonth);
    }
  }
  tabClock.addEventListener('click', ()=>setTab('clock'));
  tabSchedule.addEventListener('click', ()=>setTab('schedule'));

  function setStatus(type, text){
    statusBox.className = 'status ' + (type || '');
    statusBox.textContent = text;
  }
  function setScheduleStatus(type, text){
    scheduleStatus.className = 'status ' + (type || '');
    scheduleStatus.textContent = text;
  }

  function showCloseBtn(){ btnClose.style.display = 'block'; }
  btnClose.addEventListener('click', ()=>{ try{ liff.closeWindow(); }catch(e){} });

  function setStateUI(state){
    const s = String(state || 'UNKNOWN').toUpperCase();
    currentState = s;

    if (s === 'IN'){
      pillState.textContent = '狀態：上班中';
      btnIn.disabled = true;
      btnOut.disabled = false;
      return;
    }

    // EMPTY / OFF / UNKNOWN → 可 IN，不可 OUT
    pillState.textContent = (s === 'EMPTY') ? '狀態：紀錄空白' : '狀態：未上班/已下班';
    btnIn.disabled = false;
    btnOut.disabled = true;
  }

  function stateHintText(){
    return (currentState === 'IN')
      ? '目前狀態：上班中（請打下班卡 OUT）'
      : '目前狀態：未上班/已下班（可打上班卡 IN）';
  }

  // ===== 時間格式：以「按下按鈕當下」為主 =====
  function fmtDateTW(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const da = String(d.getDate()).padStart(2,'0');
    return `${y}/${m}/${da}`;
  }
  function fmtTimeHHmm(d){
    const hh = String(d.getHours()).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    return `${hh}:${mm}`;
  }

  // ===== 100%穩的 Flex（不碰奇怪參數，避免 invalid）=====
  function buildPunchFlex(action, when){
    const act = String(action).toUpperCase()==='OUT' ? 'OUT' : 'IN';
    const title = (act==='OUT') ? '下班打卡' : '上班打卡';
    const timeStr = fmtTimeHHmm(when);
    const dateStr = fmtDateTW(when);

    return {
      type: "flex",
      altText: `${title} ${timeStr}`,
      contents: {
        type: "bubble",
        header: {
          type: "box",
          layout: "vertical",
          backgroundColor: "#0F172A",
          paddingAll: "14px",
          contents: [
            { type: "text", text: "H.R燈藝｜員工打卡", size: "sm", weight: "bold", color: "#F5D34D" }
          ]
        },
        body: {
          type: "box",
          layout: "vertical",
          paddingAll: "16px",
          spacing: "md",
          contents: [
            { type: "text", text: "打卡已送出", size: "md", weight: "bold", color: "#16A34A" },
            {
              type: "box",
              layout: "horizontal",
              contents: [
                { type: "text", text: title, size: "lg", weight: "bold", color: "#374151", flex: 5 },
                { type: "text", text: timeStr, size: "xxl", weight: "bold", color: "#111827", flex: 5, align: "end" }
              ],
              alignItems: "baseline"
            },
            {
              type: "box",
              layout: "baseline",
              contents: [
                { type:"text", text:"日期", size:"sm", color:"#6B7280", flex:3 },
                { type:"text", text:dateStr, size:"sm", color:"#111827", flex:7, align:"end" }
              ]
            }
          ]
        },
        footer: {
          type: "box",
          layout: "vertical",
          paddingAll: "14px",
          contents: [
            { type:"button", style:"primary", action:{ type:"uri", label:"打開打卡頁", uri: LIFF_HOME_URL } }
          ]
        }
      }
    };
  }

  // ===== 用 sendBeacon/keepalive 把打卡送出（不等回應）=====
  function queueClockWrite(payload){
    try{
      // sendBeacon（最適合頁面即將關閉）
      if (navigator.sendBeacon) {
        const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
        const ok = navigator.sendBeacon('/api/clock', blob);
        if (ok) return true;
      }
    }catch(e){}

    // fallback：fetch keepalive（不要 await）
    try{
      fetch('/api/clock', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload),
        keepalive: true
      }).catch(()=>{});
      return true;
    }catch(e){
      return false;
    }
  }

  // ===== 狀態查詢（仍保留，進頁面時用來鎖定按鈕）=====
  async function refreshState(){
    if(!profile || !profile.userId) return;
    try{
      const resp = await fetch('/api/clock', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action:'STATUS', userId: profile.userId })
      });
      const data = await resp.json();
      if(data && data.ok) setStateUI(data.state || 'OFF');
      else setStateUI('UNKNOWN');
    }catch(e){
      setStateUI('UNKNOWN');
    }
  }

  function tickClock(){
    const d = new Date();
    clockEl.textContent = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  }
  setInterval(tickClock, 1000); tickClock();

  function getGps(){
    return new Promise((resolve)=>{
      navigator.geolocation.getCurrentPosition(
        pos=>{
          lastPos=pos;
          pillGps.textContent='定位已取得';
          distText.textContent='已取得（由後端判斷圍欄）';
          resolve(pos);
        },
        ()=>{
          lastPos=null;
          pillGps.textContent='定位失敗';
          distText.textContent='未取得';
          resolve(null);
        },
        { enableHighAccuracy:true, timeout:12000, maximumAge:0 }
      );
    });
  }

  function fmtErr(e){
    const code = (e && (e.code ?? e.status)) ? (e.code ?? e.status) : '';
    const msg  = e && e.message ? e.message : String(e || '');
    return (code ? `CODE:${code} ` : '') + msg;
  }

  async function postClock(action){
    const act = String(action).toUpperCase();

    // 立刻反應：先用目前狀態做擋
    if(act==='IN' && currentState==='IN'){
      setStatus('warn','你目前已在上班中（請先打下班卡 OUT）');
      return;
    }
    if(act==='OUT' && currentState!=='IN'){
      setStatus('warn','你目前未上班/已下班（請先打上班卡 IN）');
      return;
    }

    if(!profile){
      setStatus('bad','尚未登入，請重新開啟。');
      showCloseBtn();
      return;
    }

    // 沒定位就先拿（這段很快；拿不到就直接提示）
    if(!lastPos) await getGps();
    if(!lastPos){
      setStatus('bad','定位未取得，請允許定位後再打卡。');
      showCloseBtn();
      return;
    }

    // ✅ 立即更新前端狀態（不等後端）
    setStateUI(act==='IN' ? 'IN' : 'OFF');
    btnIn.disabled = true;
    btnOut.disabled = true;
    setStatus('ok', '已送出打卡，正在發送 Flex…\n（不等待後台寫入）');

    const when = new Date(); // ✅ 以按下當下時間為主
    const payload = {
      action: act,
      userId: profile.userId,
      lat: lastPos.coords.latitude,
      lng: lastPos.coords.longitude,
      device: navigator.userAgent || '',
      note: '',
      client_ts: when.toISOString()
    };

    // ✅ 後台慢慢寫：先把資料丟出去（不 await）
    queueClockWrite(payload);

    // ✅ 先發 Flex（一定要在 closeWindow 前）
    const flexMsg = buildPunchFlex(act, when);
    try{
      await liff.sendMessages([flexMsg]);
    }catch(e){
      // Flex 失敗：不關閉，讓你看得到錯誤、可重試
      setStateUI(currentState); // 回到剛才狀態（你也可改成不回）
      setStatus('warn','打卡已送出，但 Flex 發送失敗：' + fmtErr(e));
      showCloseBtn();
      return;
    }

    // ✅ Flex 成功 → 立刻關閉 LIFF
    try{
      liff.closeWindow();
      return;
    }catch(e){
      // 不在 LINE 內就顯示關閉按鈕
      setStatus('ok', 'Flex 已送出 ✅\n（若未自動關閉，請按下方「關閉視窗」）');
      showCloseBtn();
      // 依狀態解鎖
      setStateUI(currentState);
    }
  }

  btnIn.addEventListener('click', ()=>postClock('IN'));
  btnOut.addEventListener('click', ()=>postClock('OUT'));

  btnCopyId.addEventListener('click', async ()=>{
    try{
      await navigator.clipboard.writeText(profile.userId);
      setStatus('ok','✅ 已複製 LINE ID，請貼到 Sheets employees');
    }catch(e){}
  });

  // ===== schedule（保留原本功能）=====
  let currentMonth = (() => {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  })();

  function changeMonth(delta){
    const [y,m] = currentMonth.split('-').map(Number);
    const d = new Date(y, m-1 + delta, 1);
    currentMonth = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    monthLabel.textContent = currentMonth;
    if(profile && profile.userId) loadSchedule(currentMonth);
  }
  btnPrev.addEventListener('click', ()=> changeMonth(-1));
  btnNext.addEventListener('click', ()=> changeMonth(1));

  function fmtSegs(segs){
    if(!segs || !segs.length) return '—';
    return segs.map(s=>`${s.start}-${s.end}`).join(' / ');
  }
  async function loadSchedule(month){
    try{
      setScheduleStatus('', '載入班表中…');
      scheduleList.innerHTML = '';
      const resp = await fetch('/api/schedule', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId: profile.userId, month })
      });
      const data = await resp.json();
      if(!data.ok){
        setScheduleStatus('bad', data.message || '班表讀取失敗');
        return;
      }
      setScheduleStatus('ok', `✅ 已載入 ${month} 班表`);
      const items = data.items || [];
      for(const it of items){
        const badgeCls = (it.type === 'WORK') ? 'badge work' : 'badge off';
        const badgeTxt = (it.type === 'WORK') ? '上班' : (it.type === 'LEAVE' ? '請假' : '休');
        const segTxt = fmtSegs(it.segments);
        const div = document.createElement('div');
        div.className='item';
        div.innerHTML = `
          <div>
            <div class="d">${it.date}</div>
            <div class="seg">${segTxt}</div>
            ${it.note ? `<div class="note">${it.note}</div>` : ``}
          </div>
          <div class="${badgeCls}">${badgeTxt}</div>
        `;
        scheduleList.appendChild(div);
      }
      if(items.length===0) setScheduleStatus('warn', '這個月沒有班表資料（或你尚未同步排班）');
    }catch(err){
      setScheduleStatus('bad', '班表載入失敗：' + (err && err.message ? err.message : err));
    }
  }

  async function init(){
    try{
      await liff.init({ liffId: LIFF_ID });

      try{
        clientText.textContent = (liff.isInClient && liff.isInClient()) ? 'LINE內（可關閉）' : '非LINE內（不可自動關閉）';
      }catch(e){ clientText.textContent='未知'; }

      if(!liff.isLoggedIn()){
        pillLogin.textContent='未登入';
        if(!liff.isInClient || !liff.isInClient()){
          setStatus('warn','請用 LINE 內開啟此頁面（LIFF）。');
          showCloseBtn();
          return;
        }
        setStatus('warn','請先登入 LINE 才能打卡。');
        liff.login(); return;
      }

      profile = await liff.getProfile();
      pillLogin.textContent='已登入';
      helloEl.textContent = `嗨 ${profile.displayName}，請先取得定位後再打卡。`;
      uidText.textContent = profile.userId || '--';
      btnCopyId.style.display = profile.userId ? 'block' : 'none';

      monthLabel.textContent = currentMonth;
      setStateUI('UNKNOWN');
      setStatus('', '讀取狀態中…');

      // 進頁面先查狀態（這個很快）
      await refreshState();
      setStatus('ok', stateHintText());

      // 定位不阻塞（背景抓）
      getGps().then(()=>{
        if(lastPos) setStatus('ok', '定位成功，' + stateHintText());
        else setStatus('warn', '定位未取得：打卡需允許定位。');
      });

    }catch(err){
      setStatus('bad','初始化失敗：' + (err && err.message ? err.message : err));
      showCloseBtn();
    }
  }

  // 初始化
  setStateUI('UNKNOWN');
  init();
</script>
</body>
</html>
