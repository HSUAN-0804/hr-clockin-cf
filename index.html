<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no"/>
  <title>H.R燈藝｜員工打卡</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg:#0b0c10;--text:#f5f5f7;--muted:#b7bbc3;--border:rgba(255,255,255,.08);
      --radius:18px;--gold:rgba(255,255,255,.80);
    }
    *{
      box-sizing:border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
      touch-action: manipulation;
    }
    input, textarea {
      -webkit-user-select: text;
      user-select: text;
      touch-action: auto;
    }
    html, body { height:100%; overflow:hidden; }

    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      background:
        radial-gradient(1200px 800px at 50% -20%, rgba(255,255,255,.06), transparent 50%),
        radial-gradient(900px 600px at 0% 0%, rgba(59,130,246,.10), transparent 55%),
        var(--bg);
      color:var(--text)
    }
    .wrap{max-width:640px;margin:0 auto;padding:18px 14px 28px;height:100vh;overflow:hidden}
    .brand{font-weight:800;letter-spacing:.5px;font-size:14px;color:var(--gold)}
    .title{margin:6px 0 12px;font-size:26px;font-weight:900}
    .tabs{display:flex;gap:10px;margin:10px 0 12px}
    .tab{flex:1;border:1px solid var(--border);background:rgba(255,255,255,.04);color:rgba(255,255,255,.85);
      padding:10px 12px;border-radius:14px;font-weight:900;text-align:center;cursor:pointer;user-select:none}
    .tab.active{border-color:rgba(255,255,255,.25);background:rgba(255,255,255,.08);color:#fff}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 16px 42px rgba(0,0,0,.35)}
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--border);
      background:rgba(0,0,0,.25);color:var(--muted);font-size:13px}
    .clock{font-size:44px;font-weight:900;letter-spacing:1px;margin:10px 0 8px}
    .sub{color:var(--muted);font-size:13px;line-height:1.4}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px}
    button{width:100%;border:none;border-radius:16px;padding:14px 14px;font-size:18px;font-weight:900;color:var(--text);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));border:1px solid var(--border);cursor:pointer}
    button:active{transform:scale(.99)}
    button[disabled]{opacity:.55;cursor:not-allowed}
    .status{margin-top:12px;padding:12px 12px;border-radius:14px;border:1px solid var(--border);
      background:rgba(0,0,0,.22);font-size:14px;line-height:1.4;color:var(--muted);white-space:pre-line}
    .status.ok{border-color:rgba(34,197,94,.35);color:rgba(220,252,231,.95)}
    .status.bad{border-color:rgba(239,68,68,.38);color:rgba(254,226,226,.95)}
    .status.warn{border-color:rgba(245,158,11,.35);color:rgba(255,237,213,.95)}
    .kv{display:grid;grid-template-columns:110px 1fr;gap:8px;margin-top:10px}
    .kv div{font-size:13px;color:var(--muted)}
    .kv b{color:var(--text);font-weight:800;word-break:break-all}
    .mini{margin-top:12px;color:rgba(255,255,255,.55);font-size:12px}
    .closebtn{margin-top:10px;width:100%;border-radius:14px;padding:12px;font-size:14px;font-weight:900;
      background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.18);color:rgba(255,255,255,.96);
      cursor:pointer;display:none}
    .hidden{display:none}

    /* schedule header */
    .scheduleTop{display:flex;gap:8px;align-items:center;margin:8px 0 12px}
    .monthBox{flex:1;border:1px solid var(--border);border-radius:14px;background:rgba(255,255,255,.04);
      padding:10px 12px;color:#fff;font-weight:900;display:flex;justify-content:space-between;align-items:center;min-width:0}
    .monthBtn{width:auto;min-width:74px;padding:10px 12px;border-radius:14px;font-size:14px;font-weight:900}

    /* calendar */
    .cal-week{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-top:10px; color:rgba(255,255,255,.55); font-size:12px; text-align:center; }
    .cal-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:8px; margin-top:8px; }
    .cal-cell{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      padding:10px 6px;
      color:rgba(255,255,255,.92);
      text-align:center;
      cursor:pointer;
    }
    .cal-cell:active{ transform:scale(.99); }
    .cal-cell[disabled]{ opacity:.25; cursor:default; }
    .cal-out{ background:transparent; border-color:transparent; }
    .cal-day{ font-weight:900; font-size:16px; line-height:1; }
    .cal-today{ border-color:rgba(255,255,255,.35); background:rgba(255,255,255,.06); }

    /* day sheet */
    .sheet.hidden{ display:none; }
    .sheet{
      position:fixed; left:0; right:0; bottom:0; top:0;
      background:rgba(0,0,0,.35);
      display:flex; align-items:flex-end; justify-content:center;
      padding:12px; z-index:9999;
    }
    .sheet-card{
      width:min(520px, 92vw);
      max-height:45vh;
      background:rgba(20,22,28,.95);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      box-shadow:0 18px 50px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .sheet-head{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .sheet-title{ font-weight:900; font-size:14px; color:rgba(255,255,255,.92); }
    .sheet-close{
      border:none;background:rgba(255,255,255,.10);
      color:rgba(255,255,255,.92);
      width:32px;height:32px;border-radius:10px;
      cursor:pointer;font-weight:900;
    }
    .sheet-body{
      padding:12px; overflow:auto; -webkit-overflow-scrolling:touch;
      color:rgba(255,255,255,.85); font-size:13px; line-height:1.5; white-space:pre-line;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="brand">員工專用</div>
    <div class="title">H.R燈藝｜打卡</div>

    <div class="tabs">
      <div class="tab active" id="tabClock">打卡</div>
      <div class="tab" id="tabSchedule">本月班表</div>
    </div>

    <div class="card" id="panelClock">
      <div class="row">
        <div class="pill" id="pillLogin">尚未登入</div>
        <div class="pill" id="pillGps">定位未取得</div>
        <div class="pill" id="pillState">狀態：讀取中</div>
      </div>

      <div class="clock" id="clock">--:--</div>
      <div class="sub" id="hello">請稍候…</div>

      <div class="kv">
        <div>距離店面</div><div><b id="distText">--</b></div>
        <div>我的LINE ID</div><div><b id="uidText">--</b></div>
        <div>LIFF環境</div><div><b id="clientText">--</b></div>
      </div>

      <button class="closebtn" id="btnClose">關閉視窗（返回LINE）</button>

      <div class="grid">
        <button id="btnIn">上班打卡</button>
        <button id="btnOut">下班打卡</button>
      </div>

      <div class="status" id="statusBox">準備中…</div>
      <div class="mini">打卡成功會由「員工端」送出 Flex（不扣官方帳號則數）。</div>
    </div>

    <div class="card hidden" id="panelSchedule">
      <div class="scheduleTop">
        <div class="monthBox">
          <span>月份</span>
          <span id="monthLabel">----</span>
        </div>
        <button class="monthBtn" id="btnPrev">上月</button>
        <button class="monthBtn" id="btnNext">下月</button>
      </div>

      <div class="status" id="scheduleStatus">尚未載入…</div>

      <div class="cal-week">
        <div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div><div>日</div>
      </div>
      <div class="cal-grid" id="calendarGrid"></div>

      <div class="sheet hidden" id="daySheet">
        <div class="sheet-card">
          <div class="sheet-head">
            <div class="sheet-title" id="dayTitle">—</div>
            <button type="button" class="sheet-close" id="dayClose" aria-label="關閉">✕</button>
          </div>
          <div class="sheet-body" id="dayBody"></div>
        </div>
      </div>

      <div class="mini">點日期查看明細（狀態/時段/備註）。</div>
    </div>
  </div>

<script>
  const LIFF_ID = "2008810311-jmqyUaTN";

  // 店家座標（前端計算距離用）
  const SHOP_LAT = 24.9714585;
  const SHOP_LNG = 121.2242778;
  const FENCE_M  = 500;

  // cache
  const SCHEDULE_CACHE_TTL_MS = 5 * 60 * 1000;
  function cacheKey_(month){ return `sched_${month}_${profile ? profile.userId : ''}`; }
  function loadCachedSchedule_(month){
    try{
      const key = cacheKey_(month);
      const raw = sessionStorage.getItem(key) || localStorage.getItem(key);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(!obj || !obj.ts || !obj.data) return null;
      if(Date.now() - obj.ts > SCHEDULE_CACHE_TTL_MS) return null;
      return obj.data;
    }catch(e){ return null; }
  }
  function saveCachedSchedule_(month, data){
    try{
      const key = cacheKey_(month);
      const obj = { ts: Date.now(), data };
      const raw = JSON.stringify(obj);
      sessionStorage.setItem(key, raw);
      try{ localStorage.setItem(key, raw); }catch(_){}
    }catch(e){}
  }

  const el = (id)=>document.getElementById(id);
  const tabClock = el('tabClock'), tabSchedule = el('tabSchedule');
  const panelClock = el('panelClock'), panelSchedule = el('panelSchedule');

  const pillLogin = el('pillLogin');
  const pillGps = el('pillGps');
  const pillState = el('pillState');
  const helloEl = el('hello');
  const statusBox = el('statusBox');
  const distText = el('distText');
  const uidText = el('uidText');
  const clientText = el('clientText');
  const btnClose = el('btnClose');
  const clockEl = el('clock');
  const btnIn = el('btnIn');
  const btnOut = el('btnOut');

  const monthLabel = el('monthLabel');
  const btnPrev = el('btnPrev');
  const btnNext = el('btnNext');
  const scheduleStatus = el('scheduleStatus');

  let profile = null;
  let lastPos = null;
  let lastDistM = null;
  let currentState = 'UNKNOWN';
  window.__empDisplayName = localStorage.getItem('empDisplayName') || '';

  function setTab(which){
    if(which==='clock'){
      tabClock.classList.add('active'); tabSchedule.classList.remove('active');
      panelClock.classList.remove('hidden'); panelSchedule.classList.add('hidden');
    }else{
      tabSchedule.classList.add('active'); tabClock.classList.remove('active');
      panelSchedule.classList.remove('hidden'); panelClock.classList.add('hidden');
      if(profile && profile.userId) loadSchedule(currentMonth);
    }
  }
  tabClock.addEventListener('click', ()=>setTab('clock'));
  tabSchedule.addEventListener('click', ()=>setTab('schedule'));

  function setStatus(type, text){
    statusBox.className = 'status ' + (type || '');
    statusBox.textContent = text;
  }
  function setScheduleStatus(type, text){
    scheduleStatus.className = 'status ' + (type || '');
    scheduleStatus.textContent = text;
  }
  function showCloseBtn(){ btnClose.style.display = 'block'; }
  btnClose.addEventListener('click', ()=>{ try{ liff.closeWindow(); }catch(e){} });

  function setStateUI(state){
    const s = String(state||'UNKNOWN').toUpperCase();
    currentState = s;
    if (s === 'IN'){
      pillState.textContent = '狀態：上班中';
      btnIn.disabled = true;
      btnOut.disabled = false;
      return;
    }
    if (s === 'EMPTY') pillState.textContent = '狀態：紀錄空白';
    else pillState.textContent = '狀態：未上班/已下班';
    btnIn.disabled = false;
    btnOut.disabled = true;
  }

  function tickClock(){
    const d = new Date();
    clockEl.textContent = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  }
  setInterval(tickClock, 1000); tickClock();

  function haversineMeters_(lat1, lng1, lat2, lng2){
    const R = 6371000;
    const toRad = (x)=>x*Math.PI/180;
    const dLat = toRad(lat2-lat1);
    const dLng = toRad(lng2-lng1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
    const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R*c;
  }
  function formatDistText_(distM){
    const d = Math.round(distM);
    const inRange = d <= FENCE_M;
    return `${d}m / ${FENCE_M}m（${inRange ? '範圍內' : '超出'}）`;
  }

  function getCurrentPositionP_(options){
    return new Promise((resolve) => {
      navigator.geolocation.getCurrentPosition(
        (pos) => resolve(pos),
        () => resolve(null),
        options
      );
    });
  }

  async function getGpsFast(){
    const pos = await getCurrentPositionP_({ enableHighAccuracy:false, timeout:2500, maximumAge:60000 });
    if(pos){
      lastPos = pos;
      lastDistM = haversineMeters_(SHOP_LAT, SHOP_LNG, pos.coords.latitude, pos.coords.longitude);
      pillGps.textContent='定位已取得';
      distText.textContent = formatDistText_(lastDistM);
    }
    return pos;
  }

  async function getGpsAccurate(){
    const pos = await getCurrentPositionP_({ enableHighAccuracy:true, timeout:12000, maximumAge:0 });
    if(pos){
      lastPos = pos;
      lastDistM = haversineMeters_(SHOP_LAT, SHOP_LNG, pos.coords.latitude, pos.coords.longitude);
      pillGps.textContent='定位已取得';
      distText.textContent = formatDistText_(lastDistM);
    }
    return pos;
  }

  async function fetchStatus_(timeoutMs){
    try{
      const controller = new AbortController();
      const timer = setTimeout(()=>controller.abort(), timeoutMs || 250);
      const resp = await fetch('/api/clock', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action:'STATUS', userId: profile.userId }),
        signal: controller.signal
      });
      clearTimeout(timer);
      const data = await resp.json().catch(()=>null);
      return data || null;
    }catch(e){ return null; }
  }

  async function refreshState(){
    if(!profile) return;
    const data = await fetchStatus_(250);
    if(data && data.ok){
      if(data.display_name){
        window.__empDisplayName = String(data.display_name).trim();
        localStorage.setItem('empDisplayName', window.__empDisplayName);
      }
      setStateUI(data.state || 'OFF');
      return;
    }
    setStateUI('OFF');
  }

  // ===== schedule =====
  let currentMonth = (() => {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  })();
  monthLabel.textContent = currentMonth;
  window.__scheduleMap = {};

  function renderCalendar_(month){
    const [yy, mm] = month.split('-').map(Number);
    const first = new Date(yy, mm-1, 1);
    const firstDow = (first.getDay() + 6) % 7; // Monday=0
    const daysInMonth = new Date(yy, mm, 0).getDate();

    const today = new Date();
    const todayKey = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '';

    for(let i=0;i<42;i++){
      const dayNum = i - firstDow + 1;
      const inMonth = dayNum >= 1 && dayNum <= daysInMonth;
      const dateKey = inMonth ? `${yy}-${String(mm).padStart(2,'0')}-${String(dayNum).padStart(2,'0')}` : '';

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'cal-cell' + (inMonth ? '' : ' cal-out') + (dateKey===todayKey ? ' cal-today' : '');
      btn.disabled = !inMonth;
      btn.innerHTML = `<div class="cal-day">${inMonth ? dayNum : ''}</div>`;
      if(inMonth){
        btn.addEventListener('click', ()=> openDayDetail_(dateKey));
      }
      grid.appendChild(btn);
    }
  }

  async function loadSchedule(month){
    try{
      setScheduleStatus('', '載入中…');

      const cached = loadCachedSchedule_(month);
      if(cached){
        window.__scheduleMap = cached.map || {};
        setScheduleStatus('ok', `✅ ${month} 班表`);
        renderCalendar_(month);
        return;
      }

      const resp = await fetch('/api/schedule', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId: profile.userId, month })
      });
      const data = await resp.json();
      if(!data.ok){
        setScheduleStatus('bad', data.message || '班表讀取失敗');
        return;
      }

      const map = {};
      const items = data.items || [];
      for(const it of items){
        if(it && it.date) map[it.date] = it;
      }
      window.__scheduleMap = map;
      saveCachedSchedule_(month, { map });

      setScheduleStatus('ok', `✅ ${month} 班表`);
      renderCalendar_(month);
    }catch(e){
      setScheduleStatus('bad', '班表載入失敗');
    }
  }

  function openDayDetail_(dateKey){
    const it = (window.__scheduleMap || {})[dateKey];
    const title = document.getElementById('dayTitle');
    const body = document.getElementById('dayBody');
    const sheet = document.getElementById('daySheet');
    title.textContent = dateKey;

    if(!it){
      body.textContent = '無班表資料';
    }else{
      const type = it.type || 'WORK';
      const segs = (it.segments && it.segments.length) ? it.segments.map(s=>`${s.start}-${s.end}`).join(' / ') : '—';
      const note = it.note ? `\n備註：${it.note}` : '';
      const typeZh = (type==='WORK') ? '上班' : (type==='LEAVE' ? '請假' : '休');
      body.textContent = `狀態：${typeZh}\n時段：${segs}${note}`;
    }
    sheet.classList.remove('hidden');
  }
  function closeDayDetail_(){
    const sheet = document.getElementById('daySheet');
    if(sheet) sheet.classList.add('hidden');
  }
  document.addEventListener('click', (e)=>{
    const t = e.target;
    if(!t) return;
    if(t.id === 'dayClose') closeDayDetail_();
    if(t.id === 'daySheet') closeDayDetail_();
  });

  btnPrev.addEventListener('click', ()=>{
    const [y,m]=currentMonth.split('-').map(Number);
    const d=new Date(y, m-2, 1);
    currentMonth = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    monthLabel.textContent=currentMonth;
    if(profile) loadSchedule(currentMonth);
  });
  btnNext.addEventListener('click', ()=>{
    const [y,m]=currentMonth.split('-').map(Number);
    const d=new Date(y, m, 1);
    currentMonth = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    monthLabel.textContent=currentMonth;
    if(profile) loadSchedule(currentMonth);
  });

  // ===== init =====
  async function init(){
    try{
      await liff.init({ liffId: LIFF_ID });
      clientText.textContent = (liff.isInClient && liff.isInClient()) ? 'LINE內' : '非LINE內';

      if(!liff.isLoggedIn()){ liff.login(); return; }

      profile = await liff.getProfile();
      pillLogin.textContent='已登入';
      helloEl.textContent = `嗨 ${profile.displayName}`;
      uidText.textContent = profile.userId || '--';

      setStatus('', '讀取狀態中…');
      await refreshState();
      setStatus('ok', '可以打卡。');

      // 開頁快定位（不阻塞）
      pillGps.textContent='定位取得中…';
      getGpsFast().then(pos=>{
        if(!pos) pillGps.textContent='定位未取得';
      });

    }catch(e){
      setStatus('bad', '初始化失敗');
      showCloseBtn();
    }
  }

  // 打卡流程（保留你既有 postClock 版本即可；這份先確保班表不卡住）
  btnIn.addEventListener('click', ()=>setStatus('warn','請使用你目前的打卡版本（保持不變）'));
  btnOut.addEventListener('click', ()=>setStatus('warn','請使用你目前的打卡版本（保持不變）'));

  // lock zoom gestures
  document.addEventListener('gesturestart', e=>e.preventDefault(), {passive:false});
  document.addEventListener('gesturechange', e=>e.preventDefault(), {passive:false});
  document.addEventListener('gestureend', e=>e.preventDefault(), {passive:false});
  let lastTouchEnd=0;
  document.addEventListener('touchend', function(e){
    const now=Date.now();
    if(now-lastTouchEnd<=300) e.preventDefault();
    lastTouchEnd=now;
  }, {passive:false});

  init();
</script>
</body>
</html>
