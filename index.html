<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>H.R燈藝｜員工打卡</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{
      --bg:#0b0c10;--text:#f5f5f7;--muted:#b7bbc3;--border:rgba(255,255,255,.08);
      --radius:18px;--gold:rgba(255,215,0,.75);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      background:radial-gradient(1200px 800px at 50% -20%, rgba(255,215,0,.10), transparent 50%),
                 radial-gradient(900px 600px at 0% 0%, rgba(59,130,246,.10), transparent 55%),
                 var(--bg);color:var(--text)}
    .wrap{max-width:640px;margin:0 auto;padding:18px 14px 28px}
    .brand{font-weight:800;letter-spacing:.5px;font-size:14px;color:var(--gold)}
    .title{margin:6px 0 12px;font-size:26px;font-weight:900}
    .tabs{display:flex;gap:10px;margin:10px 0 12px}
    .tab{flex:1;border:1px solid var(--border);background:rgba(255,255,255,.04);color:rgba(255,255,255,.85);
      padding:10px 12px;border-radius:14px;font-weight:900;text-align:center;cursor:pointer;user-select:none}
    .tab.active{border-color:rgba(255,215,0,.25);background:rgba(255,215,0,.10);color:#fff}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 16px 42px rgba(0,0,0,.35)}
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--border);
      background:rgba(0,0,0,.25);color:var(--muted);font-size:13px}
    .clock{font-size:44px;font-weight:900;letter-spacing:1px;margin:10px 0 8px}
    .sub{color:var(--muted);font-size:13px;line-height:1.4}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px}
    button{width:100%;border:none;border-radius:16px;padding:14px 14px;font-size:18px;font-weight:900;color:var(--text);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));border:1px solid var(--border);cursor:pointer}
    button:active{transform:scale(.99)}
    button[disabled]{opacity:.55;cursor:not-allowed}
    .status{margin-top:12px;padding:12px 12px;border-radius:14px;border:1px solid var(--border);
      background:rgba(0,0,0,.22);font-size:14px;line-height:1.4;color:var(--muted);white-space:pre-line}
    .status.ok{border-color:rgba(34,197,94,.35);color:rgba(220,252,231,.95)}
    .status.bad{border-color:rgba(239,68,68,.38);color:rgba(254,226,226,.95)}
    .status.warn{border-color:rgba(245,158,11,.35);color:rgba(255,237,213,.95)}
    .kv{display:grid;grid-template-columns:110px 1fr;gap:8px;margin-top:10px}
    .kv div{font-size:13px;color:var(--muted)}
    .kv b{color:var(--text);font-weight:800;word-break:break-all}
    .mini{margin-top:12px;color:rgba(255,255,255,.55);font-size:12px}
    .softbtn{margin-top:10px;width:100%;border-radius:14px;padding:12px;font-size:14px;font-weight:900;
      background:rgba(255,215,0,.12);border:1px solid rgba(255,215,0,.25);color:rgba(255,255,255,.92);
      cursor:pointer;display:none}
    .closebtn{margin-top:10px;width:100%;border-radius:14px;padding:12px;font-size:14px;font-weight:900;
      background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.18);color:rgba(255,255,255,.96);
      cursor:pointer;display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">員工專用</div>
    <div class="title">H.R燈藝｜打卡</div>

    <div class="tabs">
      <div class="tab active" id="tabClock">打卡</div>
      <div class="tab" id="tabSchedule">本月班表</div>
    </div>

    <div class="card" id="panelClock">
      <div class="row">
        <div class="pill" id="pillLogin">尚未登入</div>
        <div class="pill" id="pillGps">定位未取得</div>
        <div class="pill" id="pillState">狀態：讀取中</div>
      </div>

      <div class="clock" id="clock">--:--</div>
      <div class="sub" id="hello">請稍候…</div>

      <div class="kv">
        <div>距離店面</div><div><b id="distText">--</b></div>
        <div>我的LINE ID</div><div><b id="uidText">--</b></div>
        <div>LIFF環境</div><div><b id="clientText">--</b></div>
      </div>

      <button class="softbtn" id="btnCopyDebug">複製 Flex Debug</button>
      <button class="closebtn" id="btnClose">關閉視窗（返回LINE）</button>

      <div class="grid">
        <button id="btnIn">上班打卡</button>
        <button id="btnOut">下班打卡</button>
      </div>

      <div class="status" id="statusBox">準備中…</div>
      <div class="mini">此版本會把「實際送出的 flex JSON」顯示/可複製，方便抓出 400 的欄位。</div>
    </div>
  </div>

<script>
  const LIFF_ID = "2008810311-jmqyUaTN";

  const el = (id)=>document.getElementById(id);
  const pillLogin = el('pillLogin');
  const pillGps = el('pillGps');
  const pillState = el('pillState');
  const helloEl = el('hello');
  const statusBox = el('statusBox');
  const distText = el('distText');
  const uidText = el('uidText');
  const clientText = el('clientText');
  const btnCopyDebug = el('btnCopyDebug');
  const btnClose = el('btnClose');
  const clockEl = el('clock');

  const btnIn = el('btnIn');
  const btnOut = el('btnOut');

  let profile = null;
  let lastPos = null;
  let currentState = 'UNKNOWN';
  let lastFlexDebug = '';

  function setStatus(type, text){
    statusBox.className = 'status ' + (type || '');
    statusBox.textContent = text;
  }
  function showCloseBtn(){ btnClose.style.display = 'block'; }
  btnClose.addEventListener('click', ()=>{ try{ liff.closeWindow(); }catch(e){} });

  function setStateUI(state){
    const s = String(state||'UNKNOWN').toUpperCase();
    currentState = s;
    if (s === 'IN'){
      pillState.textContent = '狀態：上班中';
      btnIn.disabled = true;
      btnOut.disabled = false;
      return;
    }
    if (s === 'EMPTY') pillState.textContent = '狀態：紀錄空白';
    else pillState.textContent = '狀態：未上班/已下班';
    btnIn.disabled = false;
    btnOut.disabled = true;
  }

  function tickClock(){
    const d = new Date();
    clockEl.textContent = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  }
  setInterval(tickClock, 1000); tickClock();

  async function getGps(){
    return new Promise((resolve)=>{
      navigator.geolocation.getCurrentPosition(
        pos=>{
          lastPos = pos;
          pillGps.textContent='定位已取得';
          distText.textContent='已取得（由後端判斷圍欄）';
          resolve(pos);
        },
        ()=>{
          lastPos = null;
          pillGps.textContent='定位失敗';
          distText.textContent='未取得';
          resolve(null);
        },
        { enableHighAccuracy:true, timeout:12000, maximumAge:0 }
      );
    });
  }

  function fmtErr(e){
    // LIFF 的錯誤通常 e.code/e.message，這裡把完整物件也抓出來
    let msg = '';
    try { msg = JSON.stringify(e); } catch(_){}
    const code = (e && (e.code ?? e.status)) ? (e.code ?? e.status) : '';
    const m = e && e.message ? e.message : String(e || '');
    return (code ? `CODE:${code} ` : '') + m + (msg ? `\nraw=${msg}` : '');
  }

  function normalizeFlexMessage(flex){
    let obj = flex;

    // 如果後端回的是 stringified JSON
    if (typeof obj === 'string') {
      try { obj = JSON.parse(obj); } catch(_){}
    }

    // 如果只回 bubble，包成 flex message
    if (obj && obj.type === 'bubble') {
      obj = { type:'flex', altText:'打卡系統', contents: obj };
    }

    // 如果是 flex 但缺 altText
    if (obj && obj.type === 'flex' && !obj.altText) obj.altText = '打卡系統';

    // 去掉 prototype/奇怪值
    try { obj = JSON.parse(JSON.stringify(obj)); } catch(_){}

    return obj;
  }

  async function refreshState(){
    if(!profile || !profile.userId) return;
    try{
      const resp = await fetch('/api/clock', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action:'STATUS', userId: profile.userId })
      });
      const data = await resp.json();
      if(data && data.ok && data.state) setStateUI(data.state);
      else setStateUI('OFF');
    }catch(e){
      setStateUI('OFF');
    }
  }

  async function postClock(action){
    const act = String(action).toUpperCase();

    btnIn.disabled = true;
    btnOut.disabled = true;
    setStatus('', '送出打卡中…');

    if(!lastPos) await getGps();
    if(!lastPos){
      setStatus('bad','定位未取得，請允許定位後再打卡。');
      await refreshState();
      showCloseBtn();
      return;
    }

    const payload = {
      action: act,
      userId: profile.userId,
      lat: lastPos.coords.latitude,
      lng: lastPos.coords.longitude,
      accuracy: lastPos.coords.accuracy,
      device: navigator.userAgent || '',
      note: ''
    };

    const resp = await fetch('/api/clock', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });

    const data = await resp.json().catch(()=>null);
    if(!data){
      setStatus('bad','/api/clock 回應不是 JSON');
      await refreshState();
      showCloseBtn();
      return;
    }
    if(!data.ok){
      setStatus('bad', data.message || '打卡失敗');
      await refreshState();
      showCloseBtn();
      return;
    }

    const msg = normalizeFlexMessage(data.flex);

    // 組 debug
    lastFlexDebug = JSON.stringify({
      typeof_flex: typeof data.flex,
      flex_type: msg && msg.type,
      altText: msg && msg.altText,
      contents_type: msg && msg.contents && msg.contents.type,
      has_header: !!(msg && msg.contents && msg.contents.header),
      has_body: !!(msg && msg.contents && msg.contents.body),
      has_footer: !!(msg && msg.contents && msg.contents.footer),
      full: msg
    }, null, 2);

    btnCopyDebug.style.display = 'block';

    setStatus('ok', '✅ 打卡成功，準備發送 Flex...\n（若仍 400，請按「複製 Flex Debug」貼給我）');

    try{
      await liff.sendMessages([msg]);
    }catch(e){
      setStatus('warn', 'Flex 發送失敗：\n' + fmtErr(e) + '\n\n已把 debug 準備好（按上方按鈕複製）。');
      await refreshState();
      showCloseBtn();
      return;
    }

    try{ liff.closeWindow(); }catch(e){ showCloseBtn(); await refreshState(); }
  }

  btnIn.addEventListener('click', ()=>postClock('IN'));
  btnOut.addEventListener('click', ()=>postClock('OUT'));

  btnCopyDebug.addEventListener('click', async ()=>{
    try{
      await navigator.clipboard.writeText(lastFlexDebug || '');
      setStatus('ok', '✅ 已複製 debug（請貼到這裡）');
    }catch(e){
      setStatus('warn', '複製失敗，請用手機截圖 status 內容');
    }
  });

  async function init(){
    try{
      await liff.init({ liffId: LIFF_ID });

      clientText.textContent = (liff.isInClient && liff.isInClient()) ? 'LINE內' : '非LINE內';
      if(!liff.isLoggedIn()){ liff.login(); return; }

      profile = await liff.getProfile();
      pillLogin.textContent = '已登入';
      helloEl.textContent = `嗨 ${profile.displayName}`;
      uidText.textContent = profile.userId || '--';

      setStateUI('UNKNOWN');
      setStatus('', '讀取狀態中…');
      await refreshState();
      setStatus('ok', '狀態已更新，可以打卡。');

      getGps();

    }catch(err){
      setStatus('bad','初始化失敗：' + fmtErr(err));
      showCloseBtn();
    }
  }

  init();
</script>
</body>
</html>
