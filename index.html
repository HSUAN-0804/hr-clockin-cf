<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no"/>
  <title>H.R燈藝｜員工打卡</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{
      --bg:#0b0c10;--text:#f5f5f7;--muted:#b7bbc3;--border:rgba(255,255,255,.08);
      --radius:18px;--accent:rgba(255,255,255,.80);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%;overflow:hidden}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      background:
        radial-gradient(1200px 800px at 50% -20%, rgba(255,255,255,.06), transparent 50%),
        radial-gradient(900px 600px at 0% 0%, rgba(59,130,246,.10), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:640px;margin:0 auto;padding:18px 14px 28px;height:100vh;overflow:hidden}
    .brand{font-weight:800;letter-spacing:.5px;font-size:14px;color:var(--accent)}
    .title{margin:6px 0 12px;font-size:26px;font-weight:900}
    .tabs{display:flex;gap:10px;margin:10px 0 12px}
    .tab{
      flex:1;border:1px solid var(--border);background:rgba(255,255,255,.04);color:rgba(255,255,255,.88);
      padding:10px 12px;border-radius:14px;font-weight:900;text-align:center;cursor:pointer;user-select:none
    }
    .tab.active{border-color:rgba(255,255,255,.25);background:rgba(255,255,255,.08)}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);border-radius:var(--radius);padding:16px;
      box-shadow:0 16px 42px rgba(0,0,0,.35)
    }
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--border);
      background:rgba(0,0,0,.25);color:var(--muted);font-size:13px
    }
    .clock{font-size:44px;font-weight:900;letter-spacing:1px;margin:10px 0 8px}
    .sub{color:var(--muted);font-size:13px;line-height:1.4}
    .kv{display:grid;grid-template-columns:110px 1fr;gap:8px;margin-top:10px}
    .kv div{font-size:13px;color:var(--muted)}
    .kv b{color:var(--text);font-weight:800;word-break:break-all}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px}
    button{
      width:100%;border:none;border-radius:16px;padding:14px 14px;font-size:18px;font-weight:900;color:var(--text);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border:1px solid var(--border);cursor:pointer;touch-action:manipulation
    }
    button:active{transform:scale(.99)}
    button[disabled]{opacity:.55;cursor:not-allowed}
    .status{
      margin-top:12px;padding:12px 12px;border-radius:14px;border:1px solid var(--border);
      background:rgba(0,0,0,.22);font-size:14px;line-height:1.4;color:var(--muted);white-space:pre-line
    }
    .status.ok{border-color:rgba(34,197,94,.35);color:rgba(220,252,231,.95)}
    .status.bad{border-color:rgba(239,68,68,.38);color:rgba(254,226,226,.95)}
    .status.warn{border-color:rgba(245,158,11,.35);color:rgba(255,237,213,.95)}
    .closebtn{
      margin-top:10px;width:100%;border-radius:14px;padding:12px;font-size:14px;font-weight:900;
      background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.18);color:rgba(255,255,255,.96);
      cursor:pointer;display:none
    }
    .hidden{display:none}

    /* Schedule */
    .scheduleTop{display:flex;gap:8px;align-items:center;margin:8px 0 12px}
    .monthBox{
      flex:1;border:1px solid var(--border);border-radius:14px;background:rgba(255,255,255,.04);
      padding:10px 12px;color:#fff;font-weight:900;display:flex;justify-content:space-between;align-items:center;min-width:0
    }
    .monthBtn{
      width:auto;min-width:74px;
      padding:10px 12px;border-radius:14px;font-size:14px;font-weight:900
    }
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .cal-cell{
      border:1px solid var(--border);
      border-radius:14px;
      background:rgba(0,0,0,.22);
      aspect-ratio:1/1;
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
      padding:8px;
    }
    .cal-day{font-weight:900}
    .cal-week{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:8px}
    .cal-week div{color:rgba(255,255,255,.55);font-size:12px;text-align:center}

    /* Detail popup small */
    .cal-detail-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:50}
    .cal-detail-card{
      position:fixed;left:12px;right:12px;bottom:12px;
      border:1px solid var(--border);border-radius:16px;
      background:rgba(0,0,0,.85);
      color:var(--text);
      padding:12px;
      box-shadow:0 16px 42px rgba(0,0,0,.55);
      max-height:40vh;
      overflow:hidden;
      display:none;
      z-index:51
    }
    .cal-detail-head{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .cal-detail-title{font-weight:900;font-size:14px}
    .cal-detail-close{border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);border-radius:12px;padding:8px 10px;font-weight:900}
    .cal-detail-body{margin-top:10px;max-height:calc(40vh - 54px);overflow:auto;-webkit-overflow-scrolling:touch}
    .cal-kv{display:flex;justify-content:space-between;gap:10px;padding:8px 10px;border:1px solid var(--border);border-radius:12px;background:rgba(0,0,0,.25);margin-bottom:8px}
    .cal-k{color:var(--muted);font-size:13px}
    .cal-v{color:var(--text);font-size:13px;font-weight:800;text-align:right;white-space:pre-line}

    /* Lock selection */
    *{-webkit-user-select:none;user-select:none}
    input,textarea{-webkit-user-select:text;user-select:text}
  </style>
</head>
<body>
<div class="wrap">
  <div class="brand">員工專用</div>
  <div class="title">H.R燈藝｜打卡</div>

  <div class="tabs">
    <div class="tab active" id="tabClock">打卡</div>
    <div class="tab" id="tabSchedule">本月班表</div>
  </div>

  <div class="card" id="panelClock">
    <div class="row">
      <div class="pill" id="pillLogin">尚未登入</div>
      <div class="pill" id="pillGps">定位未取得</div>
      <div class="pill" id="pillState">狀態：讀取中</div>
    </div>

    <div class="clock" id="clock">--:--</div>
    <div class="sub" id="hello">請稍候…</div>

    <div class="kv">
      <div>距離店面</div><div><b id="distText">--</b></div>
      <div>我的LINE ID</div><div><b id="uidText">--</b></div>
      <div>LIFF環境</div><div><b id="clientText">--</b></div>
    </div>

    <button class="closebtn" id="btnClose">關閉視窗（返回LINE）</button>

    <div class="grid">
      <button id="btnIn">上班打卡</button>
      <button id="btnOut">下班打卡</button>
    </div>

    <div class="status" id="statusBox">準備中…</div>
  </div>

  <div class="card hidden" id="panelSchedule">
    <div class="scheduleTop">
      <div class="monthBox">
        <span>月份</span>
        <span id="monthLabel">----</span>
      </div>
      <button class="monthBtn" id="btnPrev">上月</button>
      <button class="monthBtn" id="btnNext">下月</button>
    </div>

    <div class="status" id="scheduleStatus">尚未載入…</div>
    <div class="cal-week">
      <div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div><div>日</div>
    </div>
    <div class="cal-grid" id="scheduleList"></div>
  </div>
</div>

<div class="cal-detail-backdrop" id="calBackdrop"></div>
<div class="cal-detail-card" id="calCard">
  <div class="cal-detail-head">
    <div class="cal-detail-title" id="calTitle">班表</div>
    <button class="cal-detail-close" id="calClose">關閉</button>
  </div>
  <div class="cal-detail-body" id="calBody"></div>
</div>

<script>
  const LIFF_ID = "2008810311-jmqyUaTN";

  // ===== Status cache (localStorage) =====
  const STATUS_CACHE_TTL_MS = 60 * 1000; // 60 seconds
  function statusKey_(userId){ return `hr_status_${userId}`; }
  function loadStatusCache_(userId){
    try{
      const raw = localStorage.getItem(statusKey_(userId));
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(!obj || !obj.ts || !obj.data) return null;
      if(Date.now() - obj.ts > STATUS_CACHE_TTL_MS) return null;
      return obj.data;
    }catch(e){ return null; }
  }
  function saveStatusCache_(userId, data){
    try{
      localStorage.setItem(statusKey_(userId), JSON.stringify({ts: Date.now(), data}));
    }catch(e){}

  // ===== Local punch guard (prevent duplicate IN/OUT even if backend slow) =====
  const PUNCH_GUARD_TTL_MS = 12 * 60 * 60 * 1000; // 12 hours (same day usage)
  function punchKey_(userId){ return `hr_punch_state_${userId}`; }

  function loadPunchGuard_(userId){
    try{
      const raw = localStorage.getItem(punchKey_(userId));
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(!obj || !obj.ts || !obj.state) return null;
      if(Date.now() - obj.ts > PUNCH_GUARD_TTL_MS) return null;
      return obj;
    }catch(e){ return null; }
  }

  function savePunchGuard_(userId, state){
    try{
      localStorage.setItem(punchKey_(userId), JSON.stringify({ts: Date.now(), state}));
    }catch(e){}
  }

  // debounce clicks per action
  let lastClickTs = 0;
  function canClickNow_(){
    const now = Date.now();
    if(now - lastClickTs < 1200) return false; // 1.2s
    lastClickTs = now;
    return true;
  }
  }
  // 店家座標（前端計算距離用）
  const SHOP_LAT = 24.9714585;
  const SHOP_LNG = 121.2242778;
  const FENCE_M  = 500;

  // cache
  const SCHEDULE_CACHE_TTL_MS = 10 * 60 * 1000;
  function cacheKey_(userId, month){ return `hr_schedule_${userId}_${month}`; }
  function loadScheduleCache_(userId, month){
    try{
      const raw = localStorage.getItem(cacheKey_(userId, month));
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(!obj || !obj.ts || !obj.data) return null;
      if(Date.now() - obj.ts > SCHEDULE_CACHE_TTL_MS) return null;
      return obj.data;
    }catch(e){ return null; }
  }
  function saveScheduleCache_(userId, month, data){
    try{ localStorage.setItem(cacheKey_(userId, month), JSON.stringify({ts:Date.now(), data})); }catch(e){}
  }

  const el = (id)=>document.getElementById(id);
  const tabClock = el('tabClock'), tabSchedule = el('tabSchedule');
  const panelClock = el('panelClock'), panelSchedule = el('panelSchedule');

  const pillLogin = el('pillLogin');
  const pillGps = el('pillGps');
  const pillState = el('pillState');
  const helloEl = el('hello');
  const statusBox = el('statusBox');
  const distText = el('distText');
  const uidText = el('uidText');
  const clientText = el('clientText');
  const btnClose = el('btnClose');
  const clockEl = el('clock');

  const monthLabel = el('monthLabel');
  const btnPrev = el('btnPrev');
  const btnNext = el('btnNext');
  const scheduleStatus = el('scheduleStatus');
  const scheduleList = el('scheduleList');

  const btnIn = el('btnIn');
  const btnOut = el('btnOut');

  const calBackdrop = el('calBackdrop');
  const calCard = el('calCard');
  const calTitle = el('calTitle');
  const calBody = el('calBody');
  const calClose = el('calClose');

  let profile = null;
  let lastPos = null;
  let lastDistM = null;
  let currentState = 'UNKNOWN';
  window.__scheduleItems = [];

  function setTab(which){
    if(which==='clock'){
      tabClock.classList.add('active'); tabSchedule.classList.remove('active');
      panelClock.classList.remove('hidden'); panelSchedule.classList.add('hidden');
    }else{
      tabSchedule.classList.add('active'); tabClock.classList.remove('active');
      panelSchedule.classList.remove('hidden'); panelClock.classList.add('hidden');
      if(profile && profile.userId) loadSchedule(currentMonth);
    }
  }
  tabClock.addEventListener('click', ()=>setTab('clock'));
  tabSchedule.addEventListener('click', ()=>setTab('schedule'));

  function setStatus(type, text){
    statusBox.className = 'status ' + (type || '');
    statusBox.textContent = text;
  }
  function setScheduleStatus(type, text){
    scheduleStatus.className = 'status ' + (type || '');
    scheduleStatus.textContent = text;
  }
  function showCloseBtn(){ btnClose.style.display='block'; }
  btnClose.addEventListener('click', ()=>{ try{ liff.closeWindow(); }catch(e){} });

  function setStateUI(state){
    const s = String(state||'UNKNOWN').toUpperCase();
    currentState = s;
    if(s==='IN'){
      pillState.textContent='狀態：上班中';
      btnIn.disabled=true; btnOut.disabled=false; return;
    }
    pillState.textContent = (s==='EMPTY') ? '狀態：紀錄空白' : '狀態：未上班/已下班';
    btnIn.disabled=false; btnOut.disabled=true;
  }

  function tickClock(){
    const d=new Date();
    clockEl.textContent = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  }
  setInterval(tickClock, 1000); tickClock();

  function haversineMeters_(lat1,lng1,lat2,lng2){
    const R=6371000, toRad=(x)=>x*Math.PI/180;
    const dLat=toRad(lat2-lat1), dLng=toRad(lng2-lng1);
    const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
    const c=2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R*c;
  }
  function formatDistText_(distM){
    const d=Math.round(distM);
    const inRange = d<=FENCE_M;
    return `${d}m / ${FENCE_M}m（${inRange?'範圍內':'超出'}）`;
  }

  function getCurrentPositionP_(options){
    return new Promise((resolve)=>{
      navigator.geolocation.getCurrentPosition(
        (pos)=>resolve(pos),
        ()=>resolve(null),
        options
      );
    });
  }
  async function getGpsFast(){
    const pos = await getCurrentPositionP_({ enableHighAccuracy:false, timeout:2500, maximumAge:60000 });
    if(pos){
      lastPos = pos;
      lastDistM = haversineMeters_(SHOP_LAT, SHOP_LNG, pos.coords.latitude, pos.coords.longitude);
      pillGps.textContent='定位已取得';
      distText.textContent = formatDistText_(lastDistM);
    }
    return pos;
  }
  async function getGpsAccurate(){
    const pos = await getCurrentPositionP_({ enableHighAccuracy:true, timeout:12000, maximumAge:0 });
    if(pos){
      lastPos = pos;
      lastDistM = haversineMeters_(SHOP_LAT, SHOP_LNG, pos.coords.latitude, pos.coords.longitude);
      pillGps.textContent='定位已取得';
      distText.textContent = formatDistText_(lastDistM);
    }
    return pos;
  }

  async function refreshState(){
    if(!profile) return;
    try{
      const resp = await fetch('/api/clock', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ action:'STATUS', userId: profile.userId }) });
      const data = await resp.json();
      if(data && data.ok) setStateUI(data.state||'OFF');
      else setStateUI('OFF');
      // cache display name
      if(data && data.ok && data.display_name){
        localStorage.setItem('empDisplayName', String(data.display_name).trim());

      if(data && data.ok){
        saveStatusCache_(profile.userId, data);
        if(data && data.state){ savePunchGuard_(profile.userId, data.state); }
      }
      }
    }catch(e){
      setStateUI('OFF');
    }
  }

  // Modal
  function openDetail_(dateStr){
    const items = window.__scheduleItems || [];
    const it = items.find(x=>String(x.date)===dateStr);
    calTitle.textContent = dateStr;
    const type = it ? (it.type||'') : '—';
    const segs = it && it.segments ? it.segments.map(s=>`${s.start}-${s.end}`).join('\n') : '—';
    const note = it && it.note ? it.note : '—';
    calBody.innerHTML = '';
    const row = (k,v)=>{
      const div=document.createElement('div');
      div.className='cal-kv';
      div.innerHTML = `<div class="cal-k">${k}</div><div class="cal-v">${v}</div>`;
      calBody.appendChild(div);
    };
    row('狀態', type);
    row('時段', segs);
    row('備註', note);

    calBackdrop.style.display='block';
    calCard.style.display='block';
  }
  function closeDetail_(){
    calBackdrop.style.display='none';
    calCard.style.display='none';
  }
  calBackdrop.addEventListener('click', closeDetail_);
  calClose.addEventListener('click', closeDetail_);

  function mondayFirstIndex_(jsDay){ // 0=Sun..6=Sat -> 0=Mon..6=Sun
    return (jsDay + 6) % 7;
  }

  function renderCalendar_(month, items){
    scheduleList.innerHTML = '';
    const [y,m] = month.split('-').map(Number);
    const first = new Date(y, m-1, 1);
    const daysInMonth = new Date(y, m, 0).getDate();
    const startIdx = mondayFirstIndex_(first.getDay()); // 0..6
    // 42 cells
    for(let i=0;i<42;i++){
      const cell = document.createElement('div');
      cell.className='cal-cell';
      const dayNum = i - startIdx + 1;
      if(dayNum < 1 || dayNum > daysInMonth){
        cell.style.opacity = '0.25';
        cell.innerHTML = `<div class="cal-day"> </div>`;
      }else{
        const dateObj = new Date(y, m-1, dayNum);
        const ds = `${dateObj.getFullYear()}-${String(dateObj.getMonth()+1).padStart(2,'0')}-${String(dateObj.getDate()).padStart(2,'0')}`;
        cell.innerHTML = `<div class="cal-day">${dayNum}</div>`;
        cell.addEventListener('click', ()=>openDetail_(ds));
      }
      scheduleList.appendChild(cell);
    }
  }

  async function loadSchedule(month){
    try{
      setScheduleStatus('', '載入班表中…');
      monthLabel.textContent = month;

      // immediate render
      renderCalendar_(month, []);
      const cached = loadScheduleCache_(profile.userId, month);
      if(cached && cached.items){
        window.__scheduleItems = cached.items || [];
        setScheduleStatus('ok', `✅ 已載入 ${month} 班表（快取）`);
        return;
      }

      const resp = await fetch('/api/schedule', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId: profile.userId, month })
      });
      const data = await resp.json();
      if(!data || !data.ok){
        setScheduleStatus('bad', (data && data.message) ? data.message : '班表讀取失敗');
        window.__scheduleItems = [];
        return;
      }
      saveScheduleCache_(profile.userId, month, data);
      window.__scheduleItems = data.items || [];
      setScheduleStatus('ok', `✅ 已載入 ${month} 班表`);
    }catch(e){
      setScheduleStatus('bad', '班表載入失敗');
      window.__scheduleItems = [];
    }
  }

  // month controls
  let currentMonth = (() => {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  })();
  monthLabel.textContent = currentMonth;

  function changeMonth(delta){
    const [y,m]=currentMonth.split('-').map(Number);
    const d=new Date(y, m-1+delta, 1);
    currentMonth = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    monthLabel.textContent = currentMonth;
    if(profile && profile.userId) loadSchedule(currentMonth);
  }
  btnPrev.addEventListener('click', ()=>changeMonth(-1));
  btnNext.addEventListener('click', ()=>changeMonth(1));

  // clock submit
  async function postClock(action){
    try{
      if(!profile) throw new Error('尚未登入');
      const act = String(action||'').toUpperCase();

      if(!canClickNow_()) return;

      if(!canClickNow_()) return;

      // 使用本地狀態做更嚴格防重複
      if(act==='IN' && currentState==='IN'){
        setStatus('warn','你目前已在上班中（請先下班 OUT）');
        return;
      }
      if(act==='OUT' && currentState!=='IN'){
        setStatus('warn','你目前未上班/已下班（請先上班 IN）');
        return;
      }
      if(act!=='IN' && act!=='OUT') throw new Error('無效動作');

      // basic local guard
      if(act==='IN' && currentState==='IN'){ setStatus('warn','你目前已在上班中（請先下班 OUT）'); return; }
      if(act==='OUT' && currentState!=='IN'){ setStatus('warn','你目前未上班/已下班（請先上班 IN）'); return; }

      setStatus('', '送出打卡中…');
      btnIn.disabled=true; btnOut.disabled=true;

      // fast GPS already maybe
      if(!lastPos) await getGpsFast();
      // if fast says in range and accuracy reasonable, skip accurate; else accurate
      let distFast = lastDistM;
      let accFast = lastPos ? Number(lastPos.coords.accuracy||0) : 0;
      const ACC_THRESHOLD = Math.max(30, FENCE_M);

      const inFastRange = (distFast!=null) ? (Math.round(distFast) <= FENCE_M) : false;
      if(!(inFastRange && accFast>0 && accFast<=ACC_THRESHOLD)){
        await getGpsAccurate();
      }
      if(!lastPos){
        setStatus('bad','定位未取得，請允許定位後再打卡。');
        btnIn.disabled=false; btnOut.disabled=false; showCloseBtn(); return;
      }

      const payload = {
        action: act,
        userId: profile.userId,
        lat: lastPos.coords.latitude,
        lng: lastPos.coords.longitude,
        accuracy: lastPos.coords.accuracy,
        device: navigator.userAgent || '',
        note: ''
      };

      // try backend quickly (0.7s)
      let serverFlex = null;
      try{
        const controller = new AbortController();
        const timer = setTimeout(()=>controller.abort(), 700);
        const resp = await fetch('/api/clock', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload), signal: controller.signal });
        clearTimeout(timer);
        const data = await resp.json().catch(()=>null);
        if(data && data.ok && data.flex) serverFlex = data.flex;
      }catch(e){}

      // fallback local flex if server too slow
      const name = localStorage.getItem('empDisplayName') || '員工';
      const when = new Date();
      const hhmm = `${String(when.getHours()).padStart(2,'0')}:${String(when.getMinutes()).padStart(2,'0')}`;
      const dateStr = `${when.getFullYear()}-${String(when.getMonth()+1).padStart(2,'0')}-${String(when.getDate()).padStart(2,'0')}`;
      const timeStr = `${String(when.getHours()).padStart(2,'0')}:${String(when.getMinutes()).padStart(2,'0')}:${String(when.getSeconds()).padStart(2,'0')}`;

      const distM = (lastDistM!=null) ? lastDistM : haversineMeters_(SHOP_LAT, SHOP_LNG, payload.lat, payload.lng);
      const distTextLocal = formatDistText_(distM);
      const statusLocal = (act==='IN') ? '上班' : '下班';

      const localFlex = {
        type:'flex',
        altText:'打卡成功',
        contents:{
          type:'bubble',
          styles:{ body:{backgroundColor:'#FFFFFF'}, footer:{backgroundColor:'#FFFFFF'} },
          body:{
            type:'box',layout:'vertical',paddingAll:'16px',spacing:'md',
            contents:[
              { type:'text', text:`H.R燈藝｜員工打卡｜${name}`, size:'sm', weight:'bold', color:'#374151', wrap:true },
              { type:'separator', margin:'md', color:'#E5E7EB' },
              { type:'text', text:`${act==='IN'?'上班打卡':'下班打卡'} ${hhmm}`, size:'xxl', weight:'bold', color:'#111827', wrap:true },
              { type:'separator', margin:'md', color:'#E5E7EB' },
              { type:'box', layout:'baseline', spacing:'sm', contents:[
                { type:'text', text:'日期', size:'sm', color:'#6B7280', flex:3 },
                { type:'text', text:dateStr, size:'sm', color:'#111827', flex:7, align:'end', wrap:true }
              ]},
              { type:'box', layout:'baseline', spacing:'sm', contents:[
                { type:'text', text:'距離', size:'sm', color:'#6B7280', flex:3 },
                { type:'text', text:distTextLocal, size:'sm', color:(Math.round(distM)<=FENCE_M?'#166534':'#B91C1C'), flex:7, align:'end', wrap:true }
              ]},
              { type:'box', layout:'baseline', spacing:'sm', contents:[
                { type:'text', text:'狀態', size:'sm', color:'#6B7280', flex:3 },
                { type:'text', text:statusLocal, size:'sm', color:'#111827', flex:7, align:'end', wrap:true }
              ]}
            ]
          },
          footer:{
            type:'box',layout:'vertical',paddingAll:'14px',
            contents:[{ type:'button', style:'primary', color:'#111827', action:{ type:'uri', label:'開啟打卡頁', uri:`https://liff.line.me/${LIFF_ID}` } }]
          }
        }
      };

      const msg = serverFlex ? serverFlex : localFlex;

      // send
      await liff.sendMessages([msg]);

      // ✅ 送出後立即更新本地狀態，避免重複打卡
      const newState = (act==='IN') ? 'IN' : 'OFF';
      setStateUI(newState);
      savePunchGuard_(profile.userId, newState);

      try{ liff.closeWindow(); }catch(e){ showCloseBtn(); }
    }catch(e){
      setStatus('bad', '送出失敗');
      btnIn.disabled=false; btnOut.disabled=false; showCloseBtn();
    }
  }
  btnIn.addEventListener('click', ()=>postClock('IN'));
  btnOut.addEventListener('click', ()=>postClock('OUT'));

  // init
  async function init(){
    try{
      await liff.init({ liffId: LIFF_ID });
      clientText.textContent = (liff.isInClient && liff.isInClient()) ? 'LINE內' : '非LINE內';
      if(!liff.isLoggedIn()){ liff.login(); return; }

      profile = await liff.getProfile();

      // ✅ 本地防重複狀態（避免重複 IN/OUT）
      const pg = loadPunchGuard_(profile.userId);
      if(pg && pg.state){
        setStateUI(pg.state);
      }
      pillLogin.textContent='已登入';
      uidText.textContent = profile.userId || '--';
      helloEl.textContent = `嗨 ${profile.displayName || ''}`;

      // ✅ 一進頁面就先快定位（不等待）
      pillGps.textContent='定位取得中…';
      getGpsFast();

      setStateUI('UNKNOWN');
      // ✅ 先用 60 秒快取狀態（立即顯示）
      const cached = loadStatusCache_(profile.userId);
      if(cached && cached.state){
        setStateUI(cached.state);
        setStatus('ok', '狀態（快取）已載入，可以打卡。');
      }else{
        setStatus('', '讀取狀態中…');
      }

      // ✅ 背景更新狀態（不阻塞 UI）
      refreshState().then(()=>{ setStatus('ok', '狀態已更新，可以打卡。'); }).catch(()=>{});

    }catch(err){
      setStatus('bad','初始化失敗');
      showCloseBtn();
    }
  }

  init();

  // prevent iOS gesture zoom
  document.addEventListener('gesturestart', (e)=>e.preventDefault(), {passive:false});
  document.addEventListener('gesturechange', (e)=>e.preventDefault(), {passive:false});
  document.addEventListener('gestureend', (e)=>e.preventDefault(), {passive:false});
</script>
</body>
</html>
