<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>H.R燈藝｜員工打卡</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{
      --bg:#0b0c10;--text:#f5f5f7;--muted:#b7bbc3;--border:rgba(255,255,255,.08);
      --radius:18px;--gold:rgba(255,255,255,.80);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      background:radial-gradient(1200px 800px at 50% -20%, rgba(255,255,255,.08), transparent 50%),
                 radial-gradient(900px 600px at 0% 0%, rgba(59,130,246,.10), transparent 55%),
                 var(--bg);color:var(--text)}
    .wrap{max-width:640px;margin:0 auto;padding:18px 14px 28px}
    .brand{font-weight:800;letter-spacing:.5px;font-size:14px;color:var(--gold)}
    .title{margin:6px 0 12px;font-size:26px;font-weight:900}
    .tabs{display:flex;gap:10px;margin:10px 0 12px}
    .tab{flex:1;border:1px solid var(--border);background:rgba(255,255,255,.04);color:rgba(255,255,255,.85);
      padding:10px 12px;border-radius:14px;font-weight:900;text-align:center;cursor:pointer;user-select:none}
    .tab.active{border-color:rgba(255,255,255,.25);background:rgba(255,255,255,.08);color:#fff}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 16px 42px rgba(0,0,0,.35)}
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--border);
      background:rgba(0,0,0,.25);color:var(--muted);font-size:13px}
    .clock{font-size:44px;font-weight:900;letter-spacing:1px;margin:10px 0 8px}
    .sub{color:var(--muted);font-size:13px;line-height:1.4}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px}
    button{width:100%;border:none;border-radius:16px;padding:14px 14px;font-size:18px;font-weight:900;color:var(--text);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));border:1px solid var(--border);cursor:pointer}
    button:active{transform:scale(.99)}
    .status{margin-top:12px;padding:12px 12px;border-radius:14px;border:1px solid var(--border);
      background:rgba(0,0,0,.22);font-size:14px;line-height:1.4;color:var(--muted)}
    .status.ok{border-color:rgba(34,197,94,.35);color:rgba(220,252,231,.95)}
    .status.bad{border-color:rgba(239,68,68,.38);color:rgba(254,226,226,.95)}
    .status.warn{border-color:rgba(245,158,11,.35);color:rgba(255,237,213,.95)}
    .kv{display:grid;grid-template-columns:110px 1fr;gap:8px;margin-top:10px}
    .kv div{font-size:13px;color:var(--muted)}
    .kv b{color:var(--text);font-weight:800;word-break:break-all}
    .mini{margin-top:12px;color:rgba(255,255,255,.55);font-size:12px}
    .softbtn{margin-top:10px;width:100%;border-radius:14px;padding:12px;font-size:14px;font-weight:900;
      background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.20);color:rgba(255,255,255,.92);
      cursor:pointer;display:none}
    .closebtn{margin-top:10px;width:100%;border-radius:14px;padding:12px;font-size:14px;font-weight:900;
      background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.18);color:rgba(255,255,255,.96);
      cursor:pointer;display:none}
    .hidden{display:none}
    /* schedule */
    .scheduleTop{display:flex;gap:10px;align-items:center;margin:8px 0 12px}
    .monthBox{flex:1;border:1px solid var(--border);border-radius:14px;background:rgba(255,255,255,.04);
      padding:10px 12px;color:#fff;font-weight:900;display:flex;justify-content:space-between;align-items:center}
    .monthBtn{flex:0 0 auto;padding:10px 12px;border-radius:14px;font-weight:900}
    .list{margin-top:10px;display:flex;flex-direction:column;gap:10px}
    .item{border:1px solid var(--border);border-radius:14px;padding:12px;background:rgba(0,0,0,.22);
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .item .d{font-weight:900}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted)}
    .badge.work{border-color:rgba(34,197,94,.35);color:rgba(220,252,231,.95)}
    .badge.off{border-color:rgba(239,68,68,.35);color:rgba(254,226,226,.95)}
    .seg{color:#fff;font-weight:800}
    .note{color:rgba(255,255,255,.60);font-size:12px;margin-top:4px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">員工專用</div>
    <div class="title">H.R燈藝｜打卡</div>

    <div class="tabs">
      <div class="tab active" id="tabClock">打卡</div>
      <div class="tab" id="tabSchedule">本月班表</div>
    </div>

    <div class="card" id="panelClock">
      <div class="row">
        <div class="pill" id="pillLogin">尚未登入</div>
        <div class="pill" id="pillGps">定位未取得</div>
      </div>

      <div class="clock" id="clock">--:--</div>
      <div class="sub" id="hello">請稍候…</div>

      <div class="kv">
        <div>距離店面</div><div><b id="distText">--</b></div>
        <div>我的LINE ID</div><div><b id="uidText">--</b></div>
        <div>LIFF環境</div><div><b id="clientText">--</b></div>
      </div>

      <button class="softbtn" id="btnCopyId">一鍵複製我的LINE ID</button>
      <button class="closebtn" id="btnClose">關閉視窗（返回LINE）</button>

      <div class="grid">
        <button id="btnIn">上班打卡</button>
        <button id="btnOut">下班打卡</button>
      </div>

      <div class="status" id="statusBox">準備中…</div>
      <div class="mini">打卡成功會由「員工端」送出 Flex（不扣官方帳號則數）。</div>
    </div>

    <div class="card hidden" id="panelSchedule">
      <div class="scheduleTop">
        <div class="monthBox">
          <span>月份</span>
          <span id="monthLabel">----</span>
        </div>
        <button class="monthBtn" id="btnPrev">上月</button>
        <button class="monthBtn" id="btnNext">下月</button>
      </div>

      <div class="status" id="scheduleStatus">尚未載入…</div>
      <div class="list" id="scheduleList"></div>
      <div class="mini">班表來源：shift_overrides ＞ shift_month（PT）＞ shift_templates（FT）。</div>
    </div>
  </div>

<script>
  const LIFF_ID = "2008810311-jmqyUaTN";

  // 店家座標（前端計算距離用）
  const SHOP_LAT = 24.9714585;
  const SHOP_LNG = 121.2242778;
  const FENCE_M  = 500; // 圍欄半徑（公尺），請與 GS 的 GEOFENCE_METERS 一致

  const el = (id)=>document.getElementById(id);
  const tabClock = el('tabClock'), tabSchedule = el('tabSchedule');
  const panelClock = el('panelClock'), panelSchedule = el('panelSchedule');

  const pillLogin = el('pillLogin');
  const pillGps = el('pillGps');
  const helloEl = el('hello');
  const statusBox = el('statusBox');
  const distText = el('distText');
  const uidText = el('uidText');
  const clientText = el('clientText');
  const btnCopyId = el('btnCopyId');
  const btnClose = el('btnClose');
  const clockEl = el('clock');

  const monthLabel = el('monthLabel');
  const btnPrev = el('btnPrev');
  const btnNext = el('btnNext');
  const scheduleStatus = el('scheduleStatus');
  const scheduleList = el('scheduleList');

  let profile = null;
  let lastPos = null;
  let lastDistM = null;

  let currentMonth = (() => {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  })();

  function setTab(which){
    if(which==='clock'){
      tabClock.classList.add('active'); tabSchedule.classList.remove('active');
      panelClock.classList.remove('hidden'); panelSchedule.classList.add('hidden');
    }else{
      tabSchedule.classList.add('active'); tabClock.classList.remove('active');
      panelSchedule.classList.remove('hidden'); panelClock.classList.add('hidden');
      if(profile && profile.userId) loadSchedule(currentMonth);
    }
  }
  tabClock.addEventListener('click', ()=>setTab('clock'));
  tabSchedule.addEventListener('click', ()=>setTab('schedule'));

  function setStatus(type, text){
    statusBox.className = 'status ' + (type || '');
    statusBox.textContent = text;
  }
  function setScheduleStatus(type, text){
    scheduleStatus.className = 'status ' + (type || '');
    scheduleStatus.textContent = text;
  }
  function showCloseBtn(){ btnClose.style.display = 'block'; }
  btnClose.addEventListener('click', ()=>{ try{ liff.closeWindow(); }catch(e){} });

  function tickClock(){
    const d = new Date();
    clockEl.textContent = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  }
  setInterval(tickClock, 1000); tickClock();

  async function init(){
    try{
      await liff.init({ liffId: LIFF_ID });

      try{
        clientText.textContent = (liff.isInClient && liff.isInClient()) ? 'LINE內（可關閉）' : '非LINE內（不可自動關閉）';
      }catch(e){ clientText.textContent='未知'; }

      if(!liff.isLoggedIn()){
        pillLogin.textContent='未登入';
        if(!liff.isInClient || !liff.isInClient()){
          setStatus('warn','請用 LINE 內開啟此頁面（LIFF）。');
          showCloseBtn();
          return;
        }
        setStatus('warn','請先登入 LINE 才能打卡。');
        liff.login(); return;
      }

      profile = await liff.getProfile();

      // ✅ 使用員工註冊名（避免用 LINE 暱稱）
      window.__empDisplayName = getEmpNameCached_();
      // 背景更新一次，不阻塞
      fetchEmpDisplayName_(1200).then(n=>{
        if(n){
          window.__empDisplayName = n;
          setEmpNameCached_(n);
        }
      });
      pillLogin.textContent='已登入';
      helloEl.textContent = `嗨 ${profile.displayName}，請先取得定位後再打卡。`;
      uidText.textContent = profile.userId || '--';
      btnCopyId.style.display = profile.userId ? 'block' : 'none';

      setStatus('', '正在取得定位…');
      await getGps();

      monthLabel.textContent = currentMonth;
      btnPrev.addEventListener('click', ()=> changeMonth(-1));
      btnNext.addEventListener('click', ()=> changeMonth(1));

    }catch(err){
      setStatus('bad','初始化失敗：' + (err && err.message ? err.message : err));
      showCloseBtn();
    }
  }

  function getGps(){
    return new Promise((resolve)=>{
      navigator.geolocation.getCurrentPosition(
        pos=>{
          lastPos=pos;
          pillGps.textContent='定位已取得';
          lastDistM = haversineMeters_(SHOP_LAT, SHOP_LNG, pos.coords.latitude, pos.coords.longitude);
          distText.textContent = formatDistText_(lastDistM);
          setStatus('ok','定位成功，可以打卡。');
          resolve(pos);
        },
        ()=>{
          pillGps.textContent='定位失敗';
          setStatus('bad','定位失敗：請允許定位權限後再試一次。');
          showCloseBtn();
          resolve(null);
        },
        { enableHighAccuracy:true, timeout:12000, maximumAge:0 }
      );
    });
  }


  function haversineMeters_(lat1, lng1, lat2, lng2){
    const R = 6371000;
    const toRad = (x)=>x*Math.PI/180;
    const dLat = toRad(lat2-lat1);
    const dLng = toRad(lng2-lng1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
    const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R*c;
  }

  function formatDistText_(distM){
    const d = Math.round(distM);
    const inRange = d <= FENCE_M;
    return `${d}m / ${FENCE_M}m（${inRange ? '範圍內' : '超出'}）`;
  }
  // ===== Flex sanitize (避免 LIFF sendMessages 400/INVALID_MESSAGE) =====
  function fmtErr_(e){
    const code = (e && (e.code ?? e.status)) ? (e.code ?? e.status) : '';
    const msg  = e && e.message ? e.message : String(e || '');
    let raw = '';
    try{ raw = JSON.stringify(e); }catch(_){}
    return (code ? `CODE:${code} ` : '') + msg + (raw ? `\nraw=${raw}` : '');
  }

  // 移除 LIFF 可能拒絕的元件/屬性：filler、flex、paddingStart/paddingEnd、bubble.size
  function sanitizeFlex_(obj){
    if (obj === null || obj === undefined) return obj;

    if (Array.isArray(obj)){
      const out = [];
      for (const x of obj){
        const y = sanitizeFlex_(x);
        if (y === null) continue;
        out.push(y);
      }
      return out;
    }

    if (typeof obj === 'object'){
      if (obj.type === 'filler') return null;

      const out = {};
      for (const [k,v] of Object.entries(obj)){
                if (k === 'paddingStart' || k === 'paddingEnd') continue;
        if (k === 'size' && obj.type === 'bubble') continue; // bubble size 拿掉更穩
        out[k] = sanitizeFlex_(v);
      }
      return out;
    }

    return obj;
  }

  function normalizeFlexMessage_(flex){
    let obj = flex;

    // 後端如果回 stringified JSON
    if (typeof obj === 'string'){
      try{ obj = JSON.parse(obj); }catch(_){}
    }

    // 後端若只回 bubble
    if (obj && obj.type === 'bubble'){
      obj = { type:'flex', altText:'打卡系統', contents: obj };
    }

    // 確保 altText
    if (obj && obj.type === 'flex' && !obj.altText) obj.altText = '打卡系統';

    // deep clone
    try{ obj = JSON.parse(JSON.stringify(obj)); }catch(_){}

    // sanitize
    obj = sanitizeFlex_(obj);

    return obj;
  }

  function clone_(x){
    try{ return JSON.parse(JSON.stringify(x)); }catch(_){ return x; }
  }

  // 進一步降級：移除 footer
  function stripFooter_(msg){
    const o = clone_(msg);
    if (o && o.type==='flex' && o.contents && o.contents.type==='bubble'){
      delete o.contents.footer;
    }
    return o;
  }

  // 最低保險：超簡 flex（只留 body 一句話）
  function minimalFlex_(){
    return {
      type:'flex',
      altText:'打卡成功',
      contents:{
        type:'bubble',
        body:{
          type:'box',
          layout:'vertical',
          contents:[{ type:'text', text:'打卡成功', weight:'bold', size:'lg' }]
        }
      }
    };
  }

  let lastFlexDebug_ = '';
  const btnCopyFlexDebug_ = document.getElementById('btnCopyId'); // reuse existing button


    // ✅ 背景送出打卡（不等待後端回應）
  function queueClockWrite_(payload){
    try{
      if (navigator.sendBeacon){
        const blob = new Blob([JSON.stringify(payload)], {type:'application/json'});
        const ok = navigator.sendBeacon('/api/clock', blob);
        if (ok) return true;
      }
    }catch(e){}
    try{
      fetch('/api/clock', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload),
        keepalive:true
      }).catch(()=>{});
      return true;
    }catch(e){}
    return false;
  }


  // ✅ 取得員工註冊名稱（employees.display_name）
  async function fetchEmpDisplayName_(timeoutMs){
    try{
      const controller = new AbortController();
      const timer = setTimeout(()=>controller.abort(), timeoutMs || 1200);
      const resp = await fetch('/api/clock', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action:'STATUS', userId: profile.userId }),
        signal: controller.signal
      });
      clearTimeout(timer);
      const data = await resp.json().catch(()=>null);
      if(data && data.ok && data.display_name){
        return String(data.display_name).trim();
      }
    }catch(e){}
    return '';
  }

  function getEmpNameCached_(){
    try{
      const n = localStorage.getItem('empDisplayName') || '';
      return String(n||'').trim();
    }catch(e){ return ''; }
  }
  function setEmpNameCached_(name){
    try{ localStorage.setItem('empDisplayName', String(name||'')); }catch(e){}
  }
  // ✅ 產生「本地 Flex」（安全版，避免 400；不含 filler、不含 bubble.size）
  function buildLocalFlex_(act, name, hhmm, dateStr, timeStr, distM){
    const titleLine = (act==='IN' ? '上班打卡 ' : '下班打卡 ') + hhmm;

    const d = Math.round(Number(distM || 0));
    const inRange = d <= FENCE_M;
    const distText = `${d}m / ${FENCE_M}m（${inRange ? '範圍內' : '超出'}）`;
    const distColor = inRange ? '#166534' : '#B91C1C';

    const statusText = (act==='IN') ? '上班' : '下班';
    const statusBg = (act==='IN') ? '#DCFCE7' : '#E5E7EB';
    const statusColor = (act==='IN') ? '#166534' : '#111827';

    const rowText = (label, value, valueColor) => ({
      type: 'box',
      layout: 'baseline',
      spacing: 'sm',
      contents: [
        { type: 'text', text: String(label), size: 'sm', color: '#6B7280', flex: 3 },
        { type: 'text', text: String(value), size: 'sm', color: valueColor || '#111827', flex: 7, align: 'end', wrap: true }
      ]
    });

    const statusChip = {
      type: 'box',
      layout: 'vertical',
      backgroundColor: statusBg,
      cornerRadius: '999px',
      paddingAll: '4px',
      flex: 0,
      contents: [
        { type: 'text', text: statusText, size: 'xs', weight: 'bold', color: statusColor, wrap: false }
      ]
    };

    const rowChipRight = (label, chip) => ({
      type: 'box',
      layout: 'horizontal',
      spacing: 'sm',
      alignItems: 'center',
      contents: [
        { type: 'text', text: String(label), size: 'sm', color: '#6B7280', flex: 3 },
        { type: 'box', layout: 'horizontal', flex: 7, justifyContent: 'flex-end', contents: [ chip ] }
      ]
    });

    return {
      type:'flex',
      altText:'打卡成功',
      contents:{
        type:'bubble',
        styles:{ body:{ backgroundColor:'#FFFFFF' }, footer:{ backgroundColor:'#FFFFFF' } },
        body:{
          type:'box',
          layout:'vertical',
          paddingAll:'16px',
          spacing:'md',
          contents:[
            { type:'text', text:`H.R燈藝｜員工打卡｜${name}`, size:'sm', weight:'bold', color:'#374151', wrap:true },
            { type:'separator', margin:'md', color:'#E5E7EB' },

            { type:'text', text:titleLine, size:'xxl', weight:'bold', color:'#111827', wrap:true },
            { type:'separator', margin:'md', color:'#E5E7EB' },

            rowText('日期', dateStr, '#111827'),
            rowText('時間', timeStr, '#111827'),
            rowText('距離', distText, distColor),
            rowChipRight('狀態', statusChip)
          ]
        },
        footer:{
          type:'box',
          layout:'vertical',
          paddingAll:'14px',
          contents:[
            { type:'button', style:'primary', color:'#111827', action:{ type:'uri', label:'開啟打卡頁', uri:`https://liff.line.me/${LIFF_ID}` } }
          ]
        }
      }
    };
  }

async function postClock(action){
    try{
      if(!profile) throw new Error('尚未登入');

      const act = String(action||'').toUpperCase();
      if(act !== 'IN' && act !== 'OUT') throw new Error('無效動作');

      // 立即 UI 回饋
      setStatus('', '送出打卡中…');
      btnIn.disabled = true;
      btnOut.disabled = true;

      // GPS（必要）
      if(!lastPos) await getGps();
      if(!lastPos){
        setStatus('bad','定位未取得，請允許定位後再打卡。');
        btnIn.disabled = false;
        btnOut.disabled = false;
        showCloseBtn();
        return;
      }

      // 按下當下時間（用於 fallback local flex）
      const when = new Date();
      const hhmm = `${String(when.getHours()).padStart(2,'0')}:${String(when.getMinutes()).padStart(2,'0')}`;
      const dateStr = `${when.getFullYear()}-${String(when.getMonth()+1).padStart(2,'0')}-${String(when.getDate()).padStart(2,'0')}`;
      const timeStr = `${String(when.getHours()).padStart(2,'0')}:${String(when.getMinutes()).padStart(2,'0')}:${String(when.getSeconds()).padStart(2,'0')}`;

      // 員工註冊名（避免用 LINE 暱稱）
      let name = (window.__empDisplayName && String(window.__empDisplayName).trim()) ? String(window.__empDisplayName).trim() : getEmpNameCached_();
      if(!name){
        const n = await fetchEmpDisplayName_(300);
        if(n){
          name = n;
          window.__empDisplayName = n;
          setEmpNameCached_(n);
        }
      }
      if(!name) name = '員工';

      // 前端距離（fallback 用）
      const distM = (lastDistM != null) ? lastDistM : haversineMeters_(SHOP_LAT, SHOP_LNG, payload.lat, payload.lng);
      // 前端計算距離（fallback 本地 Flex 用）
      const distM = (lastDistM != null) ? lastDistM : haversineMeters_(SHOP_LAT, SHOP_LNG, payload.lat, payload.lng);
      const distText = formatDistText_(distM);
      const statusText = (act === 'IN') ? '上班' : '下班';
  
      const name = (window.__empDisplayName && String(window.__empDisplayName).trim())
        ? String(window.__empDisplayName).trim()
        : String(profile.displayName || '').trim() || '員工';

      const payload = {
        action: act,
        userId: profile.userId,
        lat: lastPos.coords.latitude,
        lng: lastPos.coords.longitude,
        accuracy: lastPos.coords.accuracy,
        device: navigator.userAgent || '',
        note: ''
      };

      // ✅ 嘗試拿「後端正式 flex」，但最多只等 0.7 秒（兼顧一致外觀與速度）
      let serverFlex = null;
      let wroteByServer = false;

      try{
        const controller = new AbortController();
        const timer = setTimeout(()=>controller.abort(), 700);

        const resp = await fetch('/api/clock', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload),
          signal: controller.signal
        });

        clearTimeout(timer);

        const data = await resp.json().catch(()=>null);
        if(data && data.ok && data.display_name){ window.__empDisplayName = String(data.display_name).trim(); setEmpNameCached_(window.__empDisplayName); }
        if(data && data.ok && data.flex){
          serverFlex = data.flex;
          wroteByServer = true;
        }else if(data && data.ok && !data.flex){
          // 後端 ok 但沒回 flex：也當作寫入完成，改用 local flex
          wroteByServer = true;
        }else if(data && !data.ok){
          // 後端拒絕（例如重複 IN/OUT 等）：直接顯示訊息，不送 flex
          setStatus('bad', data.message || '打卡失敗');
          btnIn.disabled = false;
          btnOut.disabled = false;
          showCloseBtn();
          return;
        }
      }catch(e){
        // timeout/abort 或網路：忽略，走 fallback
      }

      // 若後端沒在 0.7 秒內處理完，就用 beacon/keepalive 背景寫入（不等待）
      if(!wroteByServer){
        queueClockWrite_(payload);
      }

      // ✅ 選用要送的 flex：有 serverFlex 用它（外觀完全一致）；否則用 localFlex（速度優先）
      const toSend = serverFlex ? serverFlex : buildLocalFlex_(act, name, hhmm, dateStr, timeStr, distText, statusText);
      const msg = (typeof normalizeFlexMessage_ === 'function') ? normalizeFlexMessage_(toSend) : toSend;

      // 送出（保留降級重試）
      try{
        await liff.sendMessages([msg]);
      }catch(e1){
        try{
          const msg2 = (typeof stripFooter_ === 'function') ? stripFooter_(msg) : msg;
          await liff.sendMessages([msg2]);
        }catch(e2){
          const msg3 = (typeof minimalFlex_ === 'function') ? minimalFlex_() : {type:'text', text:'打卡成功'};
          await liff.sendMessages([msg3]);
        }
      }

      // ✅ 送出就關閉
      try{
        liff.closeWindow();
        return;
      }catch(e){
        setStatus('ok', 'Flex 已送出 ✅（若未自動關閉，請按「關閉視窗」）');
        btnIn.disabled = false;
        btnOut.disabled = false;
        showCloseBtn();
      }
    }catch(err){
      setStatus('bad', '送出失敗：' + (err && err.message ? err.message : err));
      btnIn.disabled = false;
      btnOut.disabled = false;
      showCloseBtn();
    }
  }

  el('btnIn').addEventListener('click', ()=>postClock('IN'));
  el('btnOut').addEventListener('click', ()=>postClock('OUT'));

  btnCopyId.addEventListener('click', async ()=>{
    try{
      await navigator.clipboard.writeText(profile.userId);
      setStatus('ok','✅ 已複製 LINE ID，請貼到 Sheets employees');
    }catch(e){}
  });

  function changeMonth(delta){
    const [y,m] = currentMonth.split('-').map(Number);
    const d = new Date(y, m-1 + delta, 1);
    currentMonth = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    monthLabel.textContent = currentMonth;
    if(profile && profile.userId) loadSchedule(currentMonth);
  }
  function fmtSegs(segs){
    if(!segs || !segs.length) return '—';
    return segs.map(s=>`${s.start}-${s.end}`).join(' / ');
  }
  async function loadSchedule(month){
    try{
      setScheduleStatus('', '載入班表中…');
      scheduleList.innerHTML = '';
      const resp = await fetch('/api/schedule', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId: profile.userId, month })
      });
      const data = await resp.json();
      if(!data.ok){
        setScheduleStatus('bad', data.message || '班表讀取失敗');
        return;
      }
      setScheduleStatus('ok', `✅ 已載入 ${month} 班表`);
      const items = data.items || [];
      for(const it of items){
        const badgeCls = (it.type === 'WORK') ? 'badge work' : 'badge off';
        const badgeTxt = (it.type === 'WORK') ? '上班' : (it.type === 'LEAVE' ? '請假' : '休');
        const segTxt = fmtSegs(it.segments);
        const div = document.createElement('div');
        div.className='item';
        div.innerHTML = `
          <div>
            <div class="d">${it.date}</div>
            <div class="seg">${segTxt}</div>
            ${it.note ? `<div class="note">${it.note}</div>` : ``}
          </div>
          <div class="${badgeCls}">${badgeTxt}</div>
        `;
        scheduleList.appendChild(div);
      }
      if(items.length===0) setScheduleStatus('warn', '這個月沒有班表資料（或你尚未同步排班）');
    }catch(err){
      setScheduleStatus('bad', '班表載入失敗：' + (err && err.message ? err.message : err));
    }
  }

  init();
</script>
</body>
</html>
