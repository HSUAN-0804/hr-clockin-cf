<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no"/>
  <title>H.R燈藝｜員工打卡</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{
      --bg:#0b0c10;--text:#f5f5f7;--muted:#b7bbc3;--border:rgba(255,255,255,.08);
      --radius:18px;--accent:rgba(255,255,255,.80);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none;touch-action:manipulation;}
    input,textarea{-webkit-user-select:text;user-select:text;touch-action:auto;}
    html, body { height: 100%; overflow: hidden; }
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      background:
        radial-gradient(1200px 800px at 50% -20%, rgba(255,255,255,.06), transparent 50%),
        radial-gradient(900px 600px at 0% 0%, rgba(59,130,246,.10), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:640px;margin:0 auto;padding:18px 14px 28px;height:100vh;overflow:hidden;}
    .brand{font-weight:800;letter-spacing:.5px;font-size:14px;color:var(--accent)}
    .title{margin:6px 0 12px;font-size:26px;font-weight:900}
    .tabs{display:flex;gap:10px;margin:10px 0 12px}
    .tab{
      flex:1;border:1px solid var(--border);background:rgba(255,255,255,.04);color:rgba(255,255,255,.85);
      padding:10px 12px;border-radius:14px;font-weight:900;text-align:center;cursor:pointer;user-select:none
    }
    .tab.active{border-color:rgba(255,255,255,.25);background:rgba(255,255,255,.08);color:#fff}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 16px 42px rgba(0,0,0,.35)
    }
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--border);
      background:rgba(0,0,0,.25);color:var(--muted);font-size:13px}
    .clock{font-size:44px;font-weight:900;letter-spacing:1px;margin:10px 0 8px}
    .sub{color:var(--muted);font-size:13px;line-height:1.4}
    .kv{display:grid;grid-template-columns:110px 1fr;gap:8px;margin-top:10px}
    .kv div{font-size:13px;color:var(--muted)}
    .kv b{color:var(--text);font-weight:800;word-break:break-all}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px}
    button{
      width:100%;border:none;border-radius:16px;padding:14px 14px;font-size:18px;font-weight:900;color:var(--text);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border:1px solid var(--border);cursor:pointer
    }
    button:active{transform:scale(.99)}
    button[disabled]{opacity:.55;cursor:not-allowed}
    .status{
      margin-top:12px;padding:12px 12px;border-radius:14px;border:1px solid var(--border);
      background:rgba(0,0,0,.22);font-size:14px;line-height:1.4;color:var(--muted);white-space:pre-line
    }
    .status.ok{border-color:rgba(34,197,94,.35);color:rgba(220,252,231,.95)}
    .status.bad{border-color:rgba(239,68,68,.38);color:rgba(254,226,226,.95)}
    .status.warn{border-color:rgba(245,158,11,.35);color:rgba(255,237,213,.95)}
    .mini{margin-top:12px;color:rgba(255,255,255,.55);font-size:12px}
    .softbtn{margin-top:10px;width:100%;border-radius:14px;padding:12px;font-size:14px;font-weight:900;
      background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.20);color:rgba(255,255,255,.92);cursor:pointer;display:none}
    .closebtn{margin-top:10px;width:100%;border-radius:14px;padding:12px;font-size:14px;font-weight:900;
      background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.18);color:rgba(255,255,255,.96);
      cursor:pointer;display:none}
    .hidden{display:none}

    /* ===== Schedule ===== */
    #panelSchedule{overflow:hidden;}
    .scheduleTop{display:flex;gap:8px;align-items:center;margin:8px 0 12px}
    .monthBox{
      flex:1;border:1px solid var(--border);border-radius:14px;background:rgba(255,255,255,.04);
      padding:10px 12px;color:#fff;font-weight:900;display:flex;justify-content:space-between;align-items:center;min-width:0;
    }
    .monthBtn{
      width:auto;min-width:74px;
      padding:10px 12px;border-radius:14px;font-size:14px;font-weight:900;
    }

    /* Calendar grid: only dates */
    .cal-wrap{margin-top:10px;}
    .cal-week{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:6px;}
    .cal-week div{font-size:12px;color:rgba(255,255,255,.65);text-align:center;}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;}
    .cal-cell{
      border:1px solid var(--border);
      border-radius:12px;
      background:rgba(0,0,0,.18);
      min-height:44px;
      padding:6px;
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
      cursor:pointer;
    }
    .cal-cell.is-out{opacity:.35}
    .cal-cell.today{border-color:rgba(255,255,255,.35)}
    .cal-day{font-weight:900;font-size:14px;color:#fff}

    /* Detail bottom sheet (small) */
    .cal-detail{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:flex-end;justify-content:center;padding:12px;}
    .cal-detail.show{display:flex}
    .cal-detail-card{width:min(640px,100%);max-height:38vh;background:rgba(17,19,24,.98);border:1px solid var(--border);border-radius:16px;overflow:hidden;}
    .cal-detail-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border);}
    .cal-detail-head .t{font-weight:900}
    .cal-detail-close{border:none;background:transparent;color:#fff;font-size:18px;font-weight:900;cursor:pointer;padding:6px 10px;border-radius:10px}
    .cal-detail-body{padding:12px 14px;max-height:28vh;overflow:auto;-webkit-overflow-scrolling:touch;}
    .cal-detail-body .line{color:rgba(255,255,255,.85);font-size:14px;line-height:1.5;margin-bottom:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">員工專用</div>
    <div class="title">H.R燈藝｜打卡</div>

    <div class="tabs">
      <div class="tab active" id="tabClock">打卡</div>
      <div class="tab" id="tabSchedule">本月班表</div>
    </div>

    <div class="card" id="panelClock">
      <div class="row">
        <div class="pill" id="pillLogin">尚未登入</div>
        <div class="pill" id="pillGps">定位未取得</div>
        <div class="pill" id="pillState">狀態：讀取中</div>
      </div>

      <div class="clock" id="clock">--:--</div>
      <div class="sub" id="hello">請稍候…</div>

      <div class="kv">
        <div>距離店面</div><div><b id="distText">--</b></div>
        <div>我的LINE ID</div><div><b id="uidText">--</b></div>
        <div>LIFF環境</div><div><b id="clientText">--</b></div>
      </div>

      <button class="softbtn" id="btnCopyId">一鍵複製我的LINE ID</button>
      <button class="closebtn" id="btnClose">關閉視窗（返回LINE）</button>

      <div class="grid">
        <button id="btnIn">上班打卡</button>
        <button id="btnOut">下班打卡</button>
      </div>

      <div class="status" id="statusBox">準備中…</div>
      <div class="mini">打卡成功會由「員工端」送出 Flex（不扣官方帳號則數）。</div>
    </div>

    <div class="card hidden" id="panelSchedule">
      <div class="scheduleTop">
        <div class="monthBox">
          <span>月份</span>
          <span id="monthLabel">----</span>
        </div>
        <button class="monthBtn" id="btnPrev">上月</button>
        <button class="monthBtn" id="btnNext">下月</button>
      </div>

      <div class="status" id="scheduleStatus">尚未載入…</div>

      <div class="cal-wrap">
        <div class="cal-week" id="calWeek">
          <div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div><div>日</div>
        </div>
        <div class="cal-grid" id="calGrid"></div>
      </div>

      <div class="mini">班表來源：shift_overrides ＞ shift_month（PT) ＞ shift_templates（FT）。</div>
    </div>
  </div>

  <div class="cal-detail" id="calDetail">
    <div class="cal-detail-card">
      <div class="cal-detail-head">
        <div class="t" id="calDetailTitle">2026-01-01</div>
        <button class="cal-detail-close" id="calDetailClose">✕</button>
      </div>
      <div class="cal-detail-body" id="calDetailBody"></div>
    </div>
  </div>

<script>
  const LIFF_ID = "2008810311-jmqyUaTN";
  const SHOP_LAT = 24.9714585;
  const SHOP_LNG = 121.2242778;
  const FENCE_M  = 500;

  const el = (id)=>document.getElementById(id);
  const tabClock = el('tabClock'), tabSchedule = el('tabSchedule');
  const panelClock = el('panelClock'), panelSchedule = el('panelSchedule');

  const pillLogin = el('pillLogin');
  const pillGps = el('pillGps');
  const pillState = el('pillState');
  const helloEl = el('hello');
  const statusBox = el('statusBox');
  const distText = el('distText');
  const uidText = el('uidText');
  const clientText = el('clientText');
  const btnCopyId = el('btnCopyId');
  const btnClose = el('btnClose');
  const clockEl = el('clock');

  const monthLabel = el('monthLabel');
  const btnPrev = el('btnPrev');
  const btnNext = el('btnNext');
  const scheduleStatus = el('scheduleStatus');
  const calGrid = el('calGrid');

  const detail = el('calDetail');
  const detailTitle = el('calDetailTitle');
  const detailBody = el('calDetailBody');
  const detailClose = el('calDetailClose');

  const btnIn = el('btnIn');
  const btnOut = el('btnOut');

  let profile = null;
  let lastPos = null;
  let lastDistM = null;
  let currentState = 'UNKNOWN';
  let punchInFlight = false;
  let lastPunchAt = 0;
  let lastPunchAction = '';
  const PUNCH_DEBOUNCE_MS = 30000; // 30 秒內同動作不重送


  function setStatus(type, text){
    statusBox.className = 'status ' + (type || '');
    statusBox.textContent = text;
  }
  function setScheduleStatus(type, text){
    scheduleStatus.className = 'status ' + (type || '');
    scheduleStatus.textContent = text;
  }
  function showCloseBtn(){ btnClose.style.display = 'block'; }
  btnClose.addEventListener('click', ()=>{ try{ liff.closeWindow(); }catch(e){} });

  function setStateUI(state){
    const s = String(state||'UNKNOWN').toUpperCase();
    currentState = s;
    if (s === 'IN'){
      pillState.textContent = '狀態：上班中';
      btnIn.disabled = true;
      btnOut.disabled = false;
      return;
    }
    if (s === 'EMPTY') pillState.textContent = '狀態：紀錄空白';
    else pillState.textContent = '狀態：未上班/已下班';
    btnIn.disabled = false;
    btnOut.disabled = true;
  }

  function tickClock(){
    const d = new Date();
    clockEl.textContent = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  }
  setInterval(tickClock, 1000); tickClock();

  function haversineMeters_(lat1, lng1, lat2, lng2){
    const R = 6371000;
    const toRad = (x)=>x*Math.PI/180;
    const dLat = toRad(lat2-lat1);
    const dLng = toRad(lng2-lng1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
    const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R*c;
  }
  function formatDistText_(distM){
    const d = Math.round(distM);
    const inRange = d <= FENCE_M;
    return `${d}m / ${FENCE_M}m（${inRange ? '範圍內' : '超出'}）`;
  }

  // ===== Flex sanitize (keep flex) =====
  function sanitizeFlex_(obj){
    if (obj === null || obj === undefined) return obj;
    if (Array.isArray(obj)){
      const out = [];
      for (const x of obj){
        const y = sanitizeFlex_(x);
        if (y === null) continue;
        out.push(y);
      }
      return out;
    }
    if (typeof obj === 'object'){
      if (obj.type === 'filler') return null;
      const out = {};
      for (const [k,v] of Object.entries(obj)){
        if (k === 'paddingStart' || k === 'paddingEnd') continue;
        if (k === 'size' && obj.type === 'bubble') continue;
        out[k] = sanitizeFlex_(v);
      }
      return out;
    }
    return obj;
  }
  function normalizeFlexMessage_(flex){
    let obj = flex;
    if (typeof obj === 'string'){
      try{ obj = JSON.parse(obj); }catch(e){}
    }
    if (obj && obj.type === 'bubble'){
      obj = { type:'flex', altText:'打卡系統', contents: obj };
    }
    if (obj && obj.type === 'flex' && !obj.altText) obj.altText = '打卡系統';
    try{ obj = JSON.parse(JSON.stringify(obj)); }catch(e){}
    obj = sanitizeFlex_(obj);
    return obj;
  }

  async function fetchEmpDisplayName_(timeoutMs){
    try{
      const controller = new AbortController();
      const timer = setTimeout(()=>controller.abort(), timeoutMs || 250);
      const resp = await fetch('/api/clock', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action:'STATUS', userId: profile.userId }),
        signal: controller.signal
      });
      clearTimeout(timer);
      const data = await resp.json().catch(()=>null);
      if(data && data.ok && data.display_name) return String(data.display_name).trim();
    }catch(e){}
    return '';
  }

  // ===== GPS two-stage =====
  function getCurrentPositionP_(options){
    return new Promise((resolve) => {
      navigator.geolocation.getCurrentPosition(
        (pos) => resolve(pos),
        () => resolve(null),
        options
      );
    });
  }
  async function getGpsFast(){
    const pos = await getCurrentPositionP_({ enableHighAccuracy:false, timeout:2500, maximumAge:60000 });
    if(pos){
      lastPos = pos;
      lastDistM = haversineMeters_(SHOP_LAT, SHOP_LNG, pos.coords.latitude, pos.coords.longitude);
      pillGps.textContent='定位已取得';
      distText.textContent = formatDistText_(lastDistM);
    }
    return pos;
  }
  async function getGpsAccurate(){
    const pos = await getCurrentPositionP_({ enableHighAccuracy:true, timeout:12000, maximumAge:0 });
    if(pos){
      lastPos = pos;
      lastDistM = haversineMeters_(SHOP_LAT, SHOP_LNG, pos.coords.latitude, pos.coords.longitude);
      pillGps.textContent='定位已取得';
      distText.textContent = formatDistText_(lastDistM);
    }
    return pos;
  }

  
  // ===== State cache (加速「狀態」顯示) =====
  function stateKey_(){ return `clock_state:${profile ? profile.userId : ''}`; }

  function readStateCache_(){
    try{
      const raw = localStorage.getItem(stateKey_());
      if(!raw) return null;
      const obj = JSON.parse(raw);
      // 10 分鐘內有效
      if(obj && obj.ts && (Date.now() - obj.ts) < 10*60*1000 && obj.state) return String(obj.state).toUpperCase();
    }catch(e){}
    return null;
  }

  function writeStateCache_(state){
    try{
      localStorage.setItem(stateKey_(), JSON.stringify({ ts: Date.now(), state: String(state||'').toUpperCase() }));
    }catch(e){}
  }
async function refreshState(){
    if(!profile || !profile.userId) return;
    try{
      const resp = await fetch('/api/clock', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action:'STATUS', userId: profile.userId })
      });
      const data = await resp.json().catch(()=>null);
      if(data && data.ok && data.state){ setStateUI(data.state); writeStateCache_(data.state); }
      else setStateUI('OFF');
    }catch(e){
      setStateUI('OFF');
    }
  }

  function queueClockWrite_(payload){
    try{
      if (navigator.sendBeacon){
        const blob = new Blob([JSON.stringify(payload)], {type:'application/json'});
        const ok = navigator.sendBeacon('/api/clock', blob);
        if (ok) return true;
      }
    }catch(e){}
    try{
      fetch('/api/clock', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload), keepalive:true }).catch(()=>{});
      return true;
    }catch(e){}
    return false;
  }

  function buildLocalFlex_(act, name, hhmm, dateStr, timeStr, distM){
    const titleLine = (act==='IN' ? '上班打卡 ' : '下班打卡 ') + hhmm;

    const d = Math.round(Number(distM || 0));
    const inRange = d <= FENCE_M;
    const distText2 = `${d}m / ${FENCE_M}m（${inRange ? '範圍內' : '超出'}）`;
    const distColor = inRange ? '#166534' : '#B91C1C';

    const statusText = (act==='IN') ? '上班' : '下班';
    const statusBg = (act==='IN') ? '#DCFCE7' : '#E5E7EB';
    const statusColor = (act==='IN') ? '#166534' : '#111827';

    const rowText = (label, value, valueColor) => ({
      type: 'box',
      layout: 'baseline',
      spacing: 'sm',
      contents: [
        { type: 'text', text: String(label), size: 'sm', color: '#6B7280', flex: 3 },
        { type: 'text', text: String(value), size: 'sm', color: valueColor || '#111827', flex: 7, align: 'end', wrap: true }
      ]
    });

    const statusChip = {
      type: 'box',
      layout: 'vertical',
      backgroundColor: statusBg,
      cornerRadius: '999px',
      paddingAll: '4px',
      flex: 0,
      contents: [
        { type: 'text', text: statusText, size: 'xs', weight: 'bold', color: statusColor, wrap: false }
      ]
    };

    const rowChipRight = (label, chip) => ({
      type: 'box',
      layout: 'horizontal',
      spacing: 'sm',
      alignItems: 'center',
      contents: [
        { type: 'text', text: String(label), size: 'sm', color: '#6B7280', flex: 3 },
        { type: 'box', layout: 'horizontal', flex: 7, justifyContent: 'flex-end', contents: [ chip ] }
      ]
    });

    return {
      type:'flex',
      altText:'打卡成功',
      contents:{
        type:'bubble',
        styles:{ body:{ backgroundColor:'#FFFFFF' }, footer:{ backgroundColor:'#FFFFFF' } },
        body:{
          type:'box',
          layout:'vertical',
          paddingAll:'16px',
          spacing:'md',
          contents:[
            { type:'text', text:`H.R燈藝｜員工打卡｜${name}`, size:'sm', weight:'bold', color:'#374151', wrap:true },
            { type:'separator', margin:'md', color:'#E5E7EB' },
            { type:'text', text:titleLine, size:'xxl', weight:'bold', color:'#111827', wrap:true },
            { type:'separator', margin:'md', color:'#E5E7EB' },
            rowText('日期', dateStr, '#111827'),
            rowText('時間', timeStr, '#111827'),
            rowText('距離', distText2, distColor),
            rowChipRight('狀態', statusChip)
          ]
        },
        footer:{
          type:'box',
          layout:'vertical',
          paddingAll:'14px',
          contents:[
            { type:'button', style:'primary', color:'#111827', action:{ type:'uri', label:'開啟打卡頁', uri:`https://liff.line.me/${LIFF_ID}` } }
          ]
        }
      }
    };
  }

  // ===== Schedule cache/render (split init) =====
  const scheduleCache_ = new Map();
  function schedKey_(month){ return `sched:${profile ? profile.userId : ''}:${month}`; }
  function readSchedCache_(month){
    try{
      const raw = localStorage.getItem(schedKey_(month));
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(obj && obj.ts && (Date.now() - obj.ts) < 30*60*1000 && Array.isArray(obj.items)) return obj.items;
    }catch(e){}
    return null;
  }
  function writeSchedCache_(month, items){
    try{
      scheduleCache_.set(month, items);
      localStorage.setItem(schedKey_(month), JSON.stringify({ts: Date.now(), items}));
    }catch(e){}
  }

  function ym_(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
  let currentMonth = ym_(new Date());
  monthLabel.textContent = currentMonth;

  function isToday_(d){
    const now = new Date();
    return d.getFullYear()===now.getFullYear() && d.getMonth()===now.getMonth() && d.getDate()===now.getDate();
  }
  function toDateKey_(d){
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }

  function openDetail(dateKey, item){
    detailTitle.textContent = dateKey;
    const segs = (item && item.segments && item.segments.length) ? item.segments.map(s=>`${s.start}-${s.end}`).join(' / ') : '—';
    const type = item && item.type ? item.type : 'OFF';
    const note = item && item.note ? item.note : '';
    detailBody.innerHTML = `
      <div class="line">狀態：${type}</div>
      <div class="line">時段：${segs}</div>
      ${note ? `<div class="line">備註：${note}</div>` : ``}
    `;
    detail.classList.add('show');
  }
  function closeDetail(){ detail.classList.remove('show'); }
  detailClose.onclick = closeDetail;
  detail.onclick = (e)=>{ if(e.target === detail) closeDetail(); };

  function renderCalendar_(month, items){
    const map = new Map();
    for(const it of (items||[])){
      if(it && it.date) map.set(it.date, it);
    }

    const [y,m] = month.split('-').map(Number);
    const first = new Date(y, m-1, 1);
    const firstWeekday = (first.getDay()+6)%7;
    const totalCells = 42;
    const startDate = new Date(y, m-1, 1-firstWeekday);

    const frag = document.createDocumentFragment();
    for(let i=0;i<totalCells;i++){
      const cellDate = new Date(startDate);
      cellDate.setDate(startDate.getDate()+i);
      const inMonth = cellDate.getMonth() === (m-1);
      const key = toDateKey_(cellDate);

      const cell = document.createElement('div');
      cell.className = 'cal-cell' + (!inMonth ? ' is-out' : '') + (isToday_(cellDate) ? ' today' : '');
      cell.dataset.date = key;
      cell.innerHTML = `<div class="cal-day">${cellDate.getDate()}</div>`;
      frag.appendChild(cell);
    }
    calGrid.innerHTML = '';
    calGrid.appendChild(frag);

    calGrid.onclick = (ev)=>{
      const cell = ev.target.closest('.cal-cell');
      if(!cell) return;
      if(cell.classList.contains('is-out')) return;
      const k = cell.dataset.date || '';
      const it = map.get(k) || {type:'OFF',segments:[],note:''};
      openDetail(k, it);
    };
  }

  async function loadSchedule(month){
    try{
      const cached = scheduleCache_.get(month) || readSchedCache_(month);
      if(cached){
        setScheduleStatus('ok', `✅ 已載入 ${month} 班表（快取）`);
        renderCalendar_(month, cached);
      }else{
        setScheduleStatus('', '載入班表中…');
        calGrid.innerHTML = '';
      }

      const resp = await fetch('/api/schedule', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId: profile.userId, month })
      });
      const data = await resp.json().catch(()=>null);
      if(!data || !data.ok){
        if(!cached) setScheduleStatus('bad', (data && data.message) ? data.message : '班表讀取失敗');
        return;
      }
      const items = data.items || [];
      writeSchedCache_(month, items);
      setScheduleStatus('ok', `✅ 已載入 ${month} 班表`);
      renderCalendar_(month, items);
      if(items.length===0) setScheduleStatus('warn','這個月沒有班表資料（或你尚未同步排班）');
    }catch(e){
      setScheduleStatus('bad','班表載入失敗');
    }
  }

  let scheduleInited = false;
  function showClock(){
    tabClock.classList.add('active'); tabSchedule.classList.remove('active');
    panelClock.classList.remove('hidden'); panelSchedule.classList.add('hidden');
  }
  function showSchedule(){
    tabSchedule.classList.add('active'); tabClock.classList.remove('active');
    panelSchedule.classList.remove('hidden'); panelClock.classList.add('hidden');
    if(!scheduleInited){
      scheduleInited = true;
      loadSchedule(currentMonth);
    }
  }
  tabClock.onclick = showClock;
  tabSchedule.onclick = showSchedule;

  btnPrev.onclick = ()=>{
    const [y,m] = currentMonth.split('-').map(Number);
    const d = new Date(y, m-2, 1);
    currentMonth = ym_(d);
    monthLabel.textContent = currentMonth;
    loadSchedule(currentMonth);
  };
  btnNext.onclick = ()=>{
    const [y,m] = currentMonth.split('-').map(Number);
    const d = new Date(y, m, 1);
    currentMonth = ym_(d);
    monthLabel.textContent = currentMonth;
    loadSchedule(currentMonth);
  };

  async function postClock(action){
    try{
      if(!profile) throw new Error('尚未登入');
      const act = String(action||'').toUpperCase();
      if(act!=='IN' && act!=='OUT') throw new Error('無效動作');

      if(act==='IN' && currentState==='IN'){ setStatus('warn','你目前已在上班中（請先打下班卡 OUT）'); return; }
      if(act==='OUT' && currentState!=='IN'){ setStatus('warn','你目前未上班/已下班（請先打上班卡 IN）'); return; }

      setStatus('', '送出打卡中…');

      // ✅ 前端防重複：送出中 / 30 秒內同動作連點擋
      const nowMs = Date.now();
      if(punchInFlight){
        setStatus('warn','處理中，請稍候…');
        return;
      }
      if(lastPunchAction === act && (nowMs - lastPunchAt) < PUNCH_DEBOUNCE_MS){
        setStatus('warn','你剛剛已送出打卡，請勿重複按～');
        return;
      }
      punchInFlight = true;
      lastPunchAt = nowMs;
      lastPunchAction = act;
      try{

      btnIn.disabled = true; btnOut.disabled = true;

      let distFast = null;
      let accFast = null;
      if(lastPos){
        distFast = (lastDistM != null) ? lastDistM : haversineMeters_(SHOP_LAT, SHOP_LNG, lastPos.coords.latitude, lastPos.coords.longitude);
        accFast = Number(lastPos.coords.accuracy || 0);
      }
      const ACC_THRESHOLD = Math.max(30, FENCE_M);
      const inFastRange = (distFast != null) ? (Math.round(distFast) <= FENCE_M) : false;

      if(!(inFastRange && accFast > 0 && accFast <= ACC_THRESHOLD)){
        pillGps.textContent = '定位校準中…';
        const posAcc = await getGpsAccurate();
        if(posAcc) lastPos = posAcc;
      }

      if(!lastPos){
        setStatus('bad','定位未取得，請允許定位後再打卡。');
        btnIn.disabled = false; btnOut.disabled = false;
        showCloseBtn();
        return;
      }

      const when = new Date();
      const hhmm = `${String(when.getHours()).padStart(2,'0')}:${String(when.getMinutes()).padStart(2,'0')}`;
      const dateStr = `${when.getFullYear()}-${String(when.getMonth()+1).padStart(2,'0')}-${String(when.getDate()).padStart(2,'0')}`;
      const timeStr = `${String(when.getHours()).padStart(2,'0')}:${String(when.getMinutes()).padStart(2,'0')}:${String(when.getSeconds()).padStart(2,'0')}`;

      let empName = localStorage.getItem('empDisplayName') || '';
      if(!empName){
        const n = await fetchEmpDisplayName_(250);
        if(n){
          empName = n;
          localStorage.setItem('empDisplayName', n);
        }
      }
      if(!empName) empName = '員工';

      const payload = {
        action: act,
        userId: profile.userId,
        lat: lastPos.coords.latitude,
        lng: lastPos.coords.longitude,
        accuracy: lastPos.coords.accuracy,
        device: navigator.userAgent || '',
        note: ''
      };

      let serverFlex = null;
      try{
        const controller = new AbortController();
        const timer = setTimeout(()=>controller.abort(), 700);
        const resp = await fetch('/api/clock', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload), signal: controller.signal });
        clearTimeout(timer);
        const data = await resp.json().catch(()=>null);
        if(data && data.ok && data.flex) serverFlex = data.flex;
        else if(data && !data.ok){
          setStatus('bad', data.message || '打卡失敗');
          btnIn.disabled = false; btnOut.disabled = false;
          showCloseBtn();
          return;
        }
      }catch(e){}

      if(!serverFlex){
        queueClockWrite_(payload);
      }

      const distM = (lastDistM != null) ? lastDistM : haversineMeters_(SHOP_LAT, SHOP_LNG, payload.lat, payload.lng);
      const toSend = serverFlex ? serverFlex : buildLocalFlex_(act, empName, hhmm, dateStr, timeStr, distM);
      const msg = normalizeFlexMessage_(toSend);

      try{
        await liff.sendMessages([msg]);

      // ✅ 前端立即鎖定狀態（避免重複 IN/OUT）
      if(act==='IN'){
        currentState = 'IN';
        setStateUI('IN');
        writeStateCache_('IN');
      }else{
        currentState = 'OFF';
        setStateUI('OFF');
        writeStateCache_('OFF');
      }
      }catch(e){
        setStatus('warn', 'Flex 發送失敗');
        btnIn.disabled = false; btnOut.disabled = false;
        showCloseBtn();
        return;
      }

      try{ liff.closeWindow(); return; }catch(e){}
      setStatus('ok','Flex 已送出 ✅（若未自動關閉，請按「關閉視窗」）');
      btnIn.disabled = false; btnOut.disabled = false;
      showCloseBtn();
    }catch(e){
      setStatus('bad','送出失敗');
      btnIn.disabled = false; btnOut.disabled = false;
      showCloseBtn();
    }
  }
      } finally {
        punchInFlight = false;
      }


  btnIn.onclick = ()=>postClock('IN');
  btnOut.onclick = ()=>postClock('OUT');

  async function init(){
    try{
      await liff.init({ liffId: LIFF_ID });
      try{
        clientText.textContent = (liff.isInClient && liff.isInClient()) ? 'LINE內（可關閉）' : '非LINE內';
      }catch(e){ clientText.textContent='未知'; }

      if(!liff.isLoggedIn()){
        pillLogin.textContent='未登入';
        if(!liff.isInClient || !liff.isInClient()){
          setStatus('warn','請用 LINE 內開啟此頁面（LIFF）。');
          showCloseBtn();
          return;
        }
        liff.login(); return;
      }

      profile = await liff.getProfile();
      pillLogin.textContent='已登入';
      uidText.textContent = profile.userId || '--';
      helloEl.textContent = '嗨，請先取得定位後再打卡。';

      btnCopyId.style.display = profile.userId ? 'block' : 'none';
      btnCopyId.onclick = async ()=>{
        try{
          await navigator.clipboard.writeText(profile.userId);
          setStatus('ok','✅ 已複製 LINE ID');
        }catch(e){}
      };

      fetchEmpDisplayName_(250).then(n=>{
        if(n) localStorage.setItem('empDisplayName', n);
      });

      // ✅ 先用快取狀態（秒出），沒有就用安全預設 OFF
      const cachedState = readStateCache_();
      if(cachedState){
        setStateUI(cachedState);
      }else{
        setStateUI('OFF'); // 預設：未上班/已下班（IN 可按、OUT 先灰）
      }
      setStatus('ok','已準備好，可以打卡。');

      // ✅ 狀態背景更新（不阻塞 UI）
      refreshState();
pillGps.textContent='定位取得中…';
      getGpsFast().then(pos=>{
        if(!pos) pillGps.textContent='定位未取得';
      });

      showClock();
    }catch(e){
      setStatus('bad','初始化失敗');
      showCloseBtn();
    }
  }

  
  // ✅ Debug: 捕捉 JS 錯誤，避免畫面卡在「尚未登入」
  window.addEventListener('error', (e)=>{
    try{ setStatus('bad', 'JS錯誤：' + (e && e.message ? e.message : 'unknown')); }catch(_){}
  });
  window.addEventListener('unhandledrejection', (e)=>{
    try{ setStatus('bad', 'Promise錯誤：' + (e && e.reason ? e.reason : 'unknown')); }catch(_){}
  });

init();
</script>
</body>
</html>
