<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no"/>
  <title>H.R燈藝｜員工打卡</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{
      --bg:#0b0c10;--text:#f5f5f7;--muted:#b7bbc3;--border:rgba(255,255,255,.08);
      --radius:18px;--gold:rgba(255,255,255,.80);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      background:radial-gradient(1200px 800px at 50% -20%, rgba(255,255,255,.08), transparent 50%),
                 radial-gradient(900px 600px at 0% 0%, rgba(59,130,246,.10), transparent 55%),
                 var(--bg);color:var(--text)}
    .wrap{max-width:640px;margin:0 auto;padding:18px 14px 28px}
    .brand{font-weight:800;letter-spacing:.5px;font-size:14px;color:var(--gold)}
    .title{margin:6px 0 12px;font-size:26px;font-weight:900}
    .tabs{display:flex;gap:10px;margin:10px 0 12px}
    .tab{flex:1;border:1px solid var(--border);background:rgba(255,255,255,.04);color:rgba(255,255,255,.85);
      padding:10px 12px;border-radius:14px;font-weight:900;text-align:center;cursor:pointer;user-select:none}
    .tab.active{border-color:rgba(255,255,255,.25);background:rgba(255,255,255,.08);color:#fff}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 16px 42px rgba(0,0,0,.35)}
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--border);
      background:rgba(0,0,0,.25);color:var(--muted);font-size:13px}
    .clock{font-size:44px;font-weight:900;letter-spacing:1px;margin:10px 0 8px}
    .sub{color:var(--muted);font-size:13px;line-height:1.4}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px}
    button{width:100%;border:none;border-radius:16px;padding:14px 14px;font-size:18px;font-weight:900;color:var(--text);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));border:1px solid var(--border);cursor:pointer}
    button:active{transform:scale(.99)}
    .status{margin-top:12px;padding:12px 12px;border-radius:14px;border:1px solid var(--border);
      background:rgba(0,0,0,.22);font-size:14px;line-height:1.4;color:var(--muted)}
    .status.ok{border-color:rgba(34,197,94,.35);color:rgba(220,252,231,.95)}
    .status.bad{border-color:rgba(239,68,68,.38);color:rgba(254,226,226,.95)}
    .status.warn{border-color:rgba(245,158,11,.35);color:rgba(255,237,213,.95)}
    .kv{display:grid;grid-template-columns:110px 1fr;gap:8px;margin-top:10px}
    .kv div{font-size:13px;color:var(--muted)}
    .kv b{color:var(--text);font-weight:800;word-break:break-all}
    .mini{margin-top:12px;color:rgba(255,255,255,.55);font-size:12px}
    .softbtn{margin-top:10px;width:100%;border-radius:14px;padding:12px;font-size:14px;font-weight:900;
      background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.20);color:rgba(255,255,255,.92);
      cursor:pointer;display:none}
    .closebtn{margin-top:10px;width:100%;border-radius:14px;padding:12px;font-size:14px;font-weight:900;
      background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.18);color:rgba(255,255,255,.96);
      cursor:pointer;display:none}
    .hidden{display:none}
    /* schedule */
    .scheduleTop{display:flex;gap:10px;align-items:center;margin:8px 0 12px}
    .monthBox{flex:1;border:1px solid var(--border);border-radius:14px;background:rgba(255,255,255,.04);
      padding:10px 12px;color:#fff;font-weight:900;display:flex;justify-content:space-between;align-items:center}
    .monthBtn{flex:0 0 auto;padding:10px 12px;border-radius:14px;font-weight:900}
    .list{margin-top:10px;display:flex;flex-direction:column;gap:10px}
    .item{border:1px solid var(--border);border-radius:14px;padding:12px;background:rgba(0,0,0,.22);
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .item .d{font-weight:900}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted)}
    .badge.work{border-color:rgba(34,197,94,.35);color:rgba(220,252,231,.95)}
    .badge.off{border-color:rgba(239,68,68,.35);color:rgba(254,226,226,.95)}
    .seg{color:#fff;font-weight:800}
    .note{color:rgba(255,255,255,.60);font-size:12px;margin-top:4px}
  
    /* ===== UX Fix: no page scrolling ===== */
    html, body { height: 100%; overflow: hidden; }
    .wrap { height: 100vh; overflow: hidden; }
    /* prevent scroll bounce inside panels unless explicitly allowed */
    #panelClock, #panelSchedule { overflow: hidden; }

    /* ===== Schedule header sizing ===== */
    .scheduleTop{ gap:8px; }
    .monthBox{
      padding:10px 12px;
      border-radius:14px;
      min-width: 0;
    }
    /* make prev/next buttons compact */
    .monthBtn{
      width: auto;
      min-width: 74px;
      padding:10px 12px;
      border-radius:14px;
      font-size:14px;
      font-weight:900;
    }
    /* keep schedule list within card and scroll internally if too long */
    #scheduleList{
      max-height: 52vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* ===== Lock zoom / double-tap zoom ===== */
    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
      touch-action: manipulation;
    }
    input, textarea {
      -webkit-user-select: text;
      user-select: text;
      touch-action: auto;
    }

    /* ===== Calendar ===== */
    .calendar{ margin-top: 10px; border:1px solid var(--border); border-radius:14px; background:rgba(0,0,0,.18); overflow:hidden; }
    .cal-weekdays{ display:grid; grid-template-columns:repeat(7,1fr); gap:0; border-bottom:1px solid var(--border); }
    .cal-weekdays > div{ text-align:center; padding:8px 0; font-size:12px; color:rgba(255,255,255,.70); }
    .cal-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:0; }
    .cal-cell{ border-right:1px solid var(--border); border-bottom:1px solid var(--border); min-height:62px; padding:8px; position:relative; }
    .cal-cell:nth-child(7n){ border-right:none; }
    .cal-cell.is-out{ opacity:.35; }
    .cal-day{ font-size:13px; font-weight:900; color:rgba(255,255,255,.92); }
    .cal-badge{ margin-top:6px; font-size:11px; padding:3px 8px; border-radius:999px; display:inline-block; border:1px solid var(--border); color:rgba(255,255,255,.85); background:rgba(255,255,255,.06); }
    .cal-badge.work{ border-color:rgba(255,255,255,.22); }
    .cal-badge.off{ opacity:.9; }
    .cal-time{ margin-top:6px; font-size:11px; color:rgba(255,255,255,.70); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .cal-cell.today{ outline:2px solid rgba(255,255,255,.35); outline-offset:-2px; border-radius:8px; }

    .cal-detail{ position:fixed; inset:0; display:flex; align-items:flex-end; justify-content:center; padding:12px; background:rgba(0,0,0,.55); z-index:999; }
    .cal-detail.hidden{ display:none; }
    .cal-detail-card{ width:min(640px, 100%); border-radius:18px; border:1px solid var(--border); background:rgba(15,18,24,.96); box-shadow:0 20px 60px rgba(0,0,0,.55); overflow:hidden; }
    .cal-detail-head{ display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--border); }
    .cal-detail-title{ font-weight:900; color:#fff; }
    .cal-detail-close{ border:none; background:rgba(255,255,255,.10); color:#fff; width:36px; height:36px; border-radius:12px; font-weight:900; }
    .cal-detail-body{ padding:12px 14px; color:rgba(255,255,255,.85); font-size:14px; line-height:1.5; }
    .cal-detail-row{ display:flex; justify-content:space-between; gap:10px; padding:8px 0; border-bottom:1px solid rgba(255,255,255,.06); }
    .cal-detail-row:last-child{ border-bottom:none; }
    .cal-detail-k{ color:rgba(255,255,255,.55); }
    .cal-detail-v{ color:#fff; font-weight:800; text-align:right; white-space:pre-line; }

    /* ===== Calendar (month view) ===== */
    .cal-week{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-top:10px; color:rgba(255,255,255,.55); font-size:12px; text-align:center; }
    .cal-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:8px; margin-top:8px; }
    .cal-cell{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      padding:10px 6px;
      color:rgba(255,255,255,.92);
      text-align:center;
      cursor:pointer;
    }
    .cal-cell:active{ transform:scale(.99); }
    .cal-cell[disabled]{ opacity:.25; cursor:default; }
    .cal-out{ background:transparent; border-color:transparent; }
    .cal-day{ font-weight:900; font-size:16px; line-height:1; }
    .cal-today{ border-color:rgba(255,255,255,.35); background:rgba(255,255,255,.06); }

    /* ===== Day detail sheet (smaller) ===== */
    .sheet.hidden{ display:none; }
    .sheet{
      position:fixed;
      left:0; right:0; bottom:0; top:0;
      background:rgba(0,0,0,.35);
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding:12px;
      z-index:9999;
    }
    .sheet-card{
      width:min(520px, 92vw);
      max-height:45vh;
      background:rgba(20,22,28,.95);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      box-shadow:0 18px 50px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .sheet-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .sheet-title{ font-weight:900; font-size:14px; color:rgba(255,255,255,.92); }
    .sheet-close{
      border:none;
      background:rgba(255,255,255,.10);
      color:rgba(255,255,255,.92);
      width:32px; height:32px;
      border-radius:10px;
      cursor:pointer;
      font-weight:900;
    }
    .sheet-body{
      padding:12px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      color:rgba(255,255,255,.85);
      font-size:13px;
      line-height:1.5;
      white-space:pre-line;
    }
</style>
</head>
<body>
  <div class="wrap">
    <div class="brand">員工專用</div>
    <div class="title">H.R燈藝｜打卡</div>

    <div class="tabs">
      <div class="tab active" id="tabClock">打卡</div>
      <div class="tab" id="tabSchedule">本月班表</div>
    </div>

    <div class="card" id="panelClock">
      <div class="row">
        <div class="pill" id="pillLogin">尚未登入</div>
        <div class="pill" id="pillGps">定位未取得</div>
      </div>

      <div class="clock" id="clock">--:--</div>
      <div class="sub" id="hello">請稍候…</div>

      <div class="kv">
        <div>距離店面</div><div><b id="distText">--</b></div>
        <div>我的LINE ID</div><div><b id="uidText">--</b></div>
        <div>LIFF環境</div><div><b id="clientText">--</b></div>
      </div>

      <button class="softbtn" id="btnCopyId">一鍵複製我的LINE ID</button>
      <button class="closebtn" id="btnClose">關閉視窗（返回LINE）</button>

      <div class="grid">
        <button id="btnIn">上班打卡</button>
        <button id="btnOut">下班打卡</button>
      </div>

      <div class="status" id="statusBox">準備中…</div>
      <div class="mini">打卡成功會由「員工端」送出 Flex（不扣官方帳號則數）。</div>
    </div>

    <div class="card hidden" id="panelSchedule">
      <div class="scheduleTop">
        <div class="monthBox">
          <span>月份</span>
          <span id="monthLabel">----</span>
        </div>
        <button class="monthBtn" id="btnPrev">上月</button>
        <button class="monthBtn" id="btnNext">下月</button>
      </div>

      <div class="status" id="scheduleStatus">尚未載入…</div>

      <!-- 月曆（週一為第一天） -->
      <div class="calendar" id="calendarWrap">
        <div class="cal-weekdays" id="calWeekdays">
          <div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div><div>日</div>
        </div>
        <div class="cal-grid" id="scheduleList"></div>
      </div>

      <!-- 點日期的明細卡 -->
      <div class="cal-detail hidden" id="calDetail">
        <div class="cal-detail-card">
          <div class="cal-detail-head">
            <div class="cal-detail-title" id="calDetailTitle">----</div>
            <button class="cal-detail-close" id="calDetailClose" type="button">✕</button>
          </div>
          <div class="cal-detail-body" id="calDetailBody"></div>
        </div>
      </div>

      <div class="mini">班表來源：shift_overrides ＞ shift_month（PT）＞ shift_templates（FT）。</div>
    </div>
  </div>

<script>
  // ===== 基本設定 =====
  const LIFF_ID = "2008810311-jmqyUaTN";

  // 店家座標（前端計算距離用）
  const SHOP_LAT = 24.9714585;
  const SHOP_LNG = 121.2242778;
  const FENCE_M  = 500; // 圍欄半徑（公尺），請與 GS 的 GEOFENCE_METERS 一致

  const BACKEND_TIMEOUT_MS = 700; // 0.7 秒內拿得到後端就用後端 flex；否則走 fallback

  const el = (id)=>document.getElementById(id);

  // Tabs / Panels
  const tabClock = el('tabClock');
  const tabSchedule = el('tabSchedule');
  const panelClock = el('panelClock');
  const panelSchedule = el('panelSchedule');

  // UI elements
  const pillLogin = el('pillLogin');
  const pillGps = el('pillGps');
  const helloEl = el('hello');
  const statusBox = el('statusBox');
  const distText = el('distText');
  const uidText = el('uidText');
  const clientText = el('clientText');
  const btnCopyId = el('btnCopyId');
  const btnClose = el('btnClose');
  const clockEl = el('clock');

  const monthLabel = el('monthLabel');
  const btnPrev = el('btnPrev');
  const btnNext = el('btnNext');
  const scheduleStatus = el('scheduleStatus');
  const scheduleList = el('scheduleList');

  const btnIn = el('btnIn');
  const btnOut = el('btnOut');

  // Runtime state
  let profile = null;
  let lastPos = null;
  let lastDistM = null;
  let currentState = 'UNKNOWN'; // EMPTY/OFF/IN/UNKNOWN
  window.__empDisplayName = '';

  // ===== UI helpers =====
  function setTab(which){
    if(which==='clock'){
      tabClock.classList.add('active'); tabSchedule.classList.remove('active');
      panelClock.classList.remove('hidden'); panelSchedule.classList.add('hidden');
    }else{
      tabSchedule.classList.add('active'); tabClock.classList.remove('active');
      panelSchedule.classList.remove('hidden'); panelClock.classList.add('hidden');
      if(profile && profile.userId) loadSchedule(currentMonth);
    }
  }
  tabClock.addEventListener('click', ()=>setTab('clock'));
  tabSchedule.addEventListener('click', ()=>setTab('schedule'));

  function setStatus(type, text){
    statusBox.className = 'status ' + (type || '');
    statusBox.textContent = text;
  }
  function setScheduleStatus(type, text){
    scheduleStatus.className = 'status ' + (type || '');
    scheduleStatus.textContent = text;
  }
  function showCloseBtn(){ btnClose.style.display = 'block'; }
  btnClose.addEventListener('click', ()=>{ try{ liff.closeWindow(); }catch(e){} });

  function setStateUI(state){
    const s = String(state||'UNKNOWN').toUpperCase();
    currentState = s;
    if (s === 'IN'){
      // 上班中：只能 OUT
      btnIn.disabled = true;
      btnOut.disabled = false;
      return;
    }
    // EMPTY / OFF / UNKNOWN：只能 IN
    btnIn.disabled = false;
    btnOut.disabled = true;
  }

  function tickClock(){
    const d = new Date();
    clockEl.textContent = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  }
  setInterval(tickClock, 1000); tickClock();

  function fmtErr_(e){
    const code = (e && (e.code ?? e.status)) ? (e.code ?? e.status) : '';
    const msg  = e && e.message ? e.message : String(e || '');
    let raw = '';
    try{ raw = JSON.stringify(e); }catch(_){}
    return (code ? `CODE:${code} ` : '') + msg + (raw ? `\nraw=${raw}` : '');
  }

  // ===== 距離計算 =====
  function haversineMeters_(lat1, lng1, lat2, lng2){
    const R = 6371000;
    const toRad = (x)=>x*Math.PI/180;
    const dLat = toRad(lat2-lat1);
    const dLng = toRad(lng2-lng1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
    const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R*c;
  }
  function formatDistText_(distM){
    const d = Math.round(distM);
    const inRange = d <= FENCE_M;
    return `${d}m / ${FENCE_M}m（${inRange ? '範圍內' : '超出'}）`;
  }

  function getCurrentPositionP_(options){
    return new Promise((resolve) => {
      navigator.geolocation.getCurrentPosition(
        (pos) => resolve(pos),
        () => resolve(null),
        options
      );
    });
  }

  // ✅ 開頁用：快速定位（允許快取、低精度）
  async function getGpsFast(){
    const pos = await getCurrentPositionP_({
      enableHighAccuracy: false,
      timeout: 2500,
      maximumAge: 60000
    });
    if(pos){
      lastPos = pos;
      lastDistM = haversineMeters_(SHOP_LAT, SHOP_LNG, pos.coords.latitude, pos.coords.longitude);
      pillGps.textContent='定位已取得';
      distText.textContent = formatDistText_(lastDistM);
    }
    return pos;
  }

  // ✅ 打卡用：精準定位（20~50m 建議用這個）
  async function getGpsAccurate(){
    const pos = await getCurrentPositionP_({
      enableHighAccuracy: true,
      timeout: 12000,
      maximumAge: 0
    });
    if(pos){
      lastPos = pos;
      lastDistM = haversineMeters_(SHOP_LAT, SHOP_LNG, pos.coords.latitude, pos.coords.longitude);
      pillGps.textContent='定位已取得';
      distText.textContent = formatDistText_(lastDistM);
    }
    return pos;
  }

  // ===== 員工名稱（display_name） =====
  function getEmpNameCached_(){
    try{ return localStorage.getItem('empDisplayName') || ''; }catch(e){ return ''; }
  }
  function setEmpNameCached_(name){
    try{ localStorage.setItem('empDisplayName', String(name||'')); }catch(e){}
  }
  async function fetchEmpDisplayName_(timeoutMs){
    if(!profile || !profile.userId) return '';
    try{
      const controller = new AbortController();
      const timer = setTimeout(()=>controller.abort(), timeoutMs || 250);
      const resp = await fetch('/api/clock', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action:'STATUS', userId: profile.userId }),
        signal: controller.signal
      });
      clearTimeout(timer);
      const data = await resp.json().catch(()=>null);
      if(data && data.ok && data.display_name){
        return String(data.display_name).trim();
      }
    }catch(e){}
    return '';
  }

  // ===== 後端狀態同步（也順便拿 display_name）=====
  async function refreshState(){
    if(!profile || !profile.userId) return;
    try{
      const resp = await fetch('/api/clock', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action:'STATUS', userId: profile.userId })
      });
      const data = await resp.json().catch(()=>null);
      if(data && data.ok){
        if(data.state) setStateUI(data.state);
        if(data.display_name){
          const dn = String(data.display_name).trim();
          if(dn){
            window.__empDisplayName = dn;
            setEmpNameCached_(dn);
          }
        }
      }else{
        setStateUI('OFF');
      }
    }catch(e){
      setStateUI('OFF');
    }
  }

  // ===== 背景寫入 =====
  function queueClockWrite_(payload){
    try{
      if (navigator.sendBeacon){
        const blob = new Blob([JSON.stringify(payload)], {type:'application/json'});
        const ok = navigator.sendBeacon('/api/clock', blob);
        if (ok) return true;
      }
    }catch(e){}
    try{
      fetch('/api/clock', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload),
        keepalive:true
      }).catch(()=>{});
      return true;
    }catch(e){}
    return false;
  }

  // ===== Flex sanitize =====
  function sanitizeFlex_(obj){
    if (obj === null || obj === undefined) return obj;

    if (Array.isArray(obj)){
      const out = [];
      for (const x of obj){
        const y = sanitizeFlex_(x);
        if (y === null) continue;
        out.push(y);
      }
      return out;
    }

    if (typeof obj === 'object'){
      if (obj.type === 'filler') return null;

      const out = {};
      for (const [k,v] of Object.entries(obj)){
        // 移除較常被 LIFF 嚴格驗證挑出的屬性
        if (k === 'paddingStart' || k === 'paddingEnd') continue;
        if (k === 'size' && obj.type === 'bubble') continue;
        out[k] = sanitizeFlex_(v);
      }
      return out;
    }

    return obj;
  }

  function normalizeFlexMessage_(flex){
    let obj = flex;

    if (typeof obj === 'string'){
      try{ obj = JSON.parse(obj); }catch(_){}
    }
    if (obj && obj.type === 'bubble'){
      obj = { type:'flex', altText:'打卡系統', contents: obj };
    }
    if (obj && obj.type === 'flex' && !obj.altText) obj.altText = '打卡系統';

    try{ obj = JSON.parse(JSON.stringify(obj)); }catch(_){}
    obj = sanitizeFlex_(obj);
    return obj;
  }

  // ===== fallback Flex（本地）=====
  function buildLocalFlex_(act, name, hhmm, dateStr, timeStr, distM){
    const titleLine = (act==='IN' ? '上班打卡 ' : '下班打卡 ') + hhmm;

    const d = Math.round(Number(distM || 0));
    const inRange = d <= FENCE_M;
    const distText = `${d}m / ${FENCE_M}m（${inRange ? '範圍內' : '超出'}）`;
    const distColor = inRange ? '#166534' : '#B91C1C';

    const statusText = (act==='IN') ? '上班' : '下班';
    const statusBg = (act==='IN') ? '#DCFCE7' : '#E5E7EB';
    const statusColor = (act==='IN') ? '#166534' : '#111827';

    const rowText = (label, value, valueColor) => ({
      type: 'box',
      layout: 'baseline',
      spacing: 'sm',
      contents: [
        { type: 'text', text: String(label), size: 'sm', color: '#6B7280', flex: 3 },
        { type: 'text', text: String(value), size: 'sm', color: valueColor || '#111827', flex: 7, align: 'end', wrap: true }
      ]
    });

    const statusChip = {
      type: 'box',
      layout: 'vertical',
      backgroundColor: statusBg,
      cornerRadius: '999px',
      paddingAll: '4px',
      flex: 0,
      contents: [
        { type: 'text', text: statusText, size: 'xs', weight: 'bold', color: statusColor, wrap: false }
      ]
    };

    const rowChipRight = (label, chip) => ({
      type: 'box',
      layout: 'horizontal',
      spacing: 'sm',
      alignItems: 'center',
      contents: [
        { type: 'text', text: String(label), size: 'sm', color: '#6B7280', flex: 3 },
        { type: 'box', layout: 'horizontal', flex: 7, justifyContent: 'flex-end', contents: [ chip ] }
      ]
    });

    return {
      type:'flex',
      altText:'打卡成功',
      contents:{
        type:'bubble',
        styles:{ body:{backgroundColor:'#FFFFFF'}, footer:{backgroundColor:'#FFFFFF'} },
        body:{
          type:'box',
          layout:'vertical',
          paddingAll:'16px',
          spacing:'md',
          contents:[
            { type:'text', text:`H.R燈藝｜員工打卡｜${name}`, size:'sm', weight:'bold', color:'#374151', wrap:true },
            { type:'separator', margin:'md', color:'#E5E7EB' },
            { type:'text', text:titleLine, size:'xxl', weight:'bold', color:'#111827', wrap:true },
            { type:'separator', margin:'md', color:'#E5E7EB' },
            rowText('日期', dateStr, '#111827'),
            rowText('時間', timeStr, '#111827'),
            rowText('距離', distText, distColor),
            rowChipRight('狀態', statusChip)
          ]
        },
        footer:{
          type:'box',
          layout:'vertical',
          paddingAll:'14px',
          contents:[
            { type:'button', style:'primary', color:'#111827', action:{ type:'uri', label:'開啟打卡頁', uri:`https://liff.line.me/${LIFF_ID}` } }
          ]
        }
      }
    };
  }

  // ===== 打卡送出（0.7s 優先後端，超時 fallback）=====
  async function postClock(action){
    try{
      if(!profile) throw new Error('尚未登入');

      const act = String(action||'').toUpperCase();
      if(act !== 'IN' && act !== 'OUT') throw new Error('無效動作');

      // 前端狀態先擋（減少重複）
      if(act==='IN' && currentState==='IN'){
        setStatus('warn','你目前已在上班中（請先打下班卡 OUT）');
        return;
      }
      if(act==='OUT' && currentState!=='IN'){
        setStatus('warn','你目前未上班/已下班（請先打上班卡 IN）');
        return;
      }

      setStatus('', '送出打卡中…');
      btnIn.disabled = true;
      btnOut.disabled = true;

      // 按打卡時，強制用精準定位（避免 20~50m 誤差）
      const posAcc = await getGpsAccurate();
      if(posAcc) lastPos = posAcc;
      
      if(!lastPos){
        setStatus('bad','定位未取得，請允許定位後再打卡。');
        btnIn.disabled = false;
        btnOut.disabled = false;
        showCloseBtn();
        return;
      }

      // 即時距離範圍檢查
      const distM = (lastDistM != null) ? lastDistM : haversineMeters_(SHOP_LAT, SHOP_LNG, lastPos.coords.latitude, lastPos.coords.longitude);
      if(Math.round(distM) > FENCE_M){
        setStatus('bad', `不在打卡範圍內（${formatDistText_(distM)}）`);
        btnIn.disabled = false;
        btnOut.disabled = false;
        showCloseBtn();
        return;
      }

      // 名字：優先用註冊名
      let empName = (window.__empDisplayName && String(window.__empDisplayName).trim()) ? String(window.__empDisplayName).trim() : getEmpNameCached_();
      if(!empName){
        const n = await fetchEmpDisplayName_(250);
        if(n){
          empName = n;
          window.__empDisplayName = n;
          setEmpNameCached_(n);
        }
      }
      if(!empName) empName = '員工';

      // 按下當下時間
      const when = new Date();
      const hhmm = `${String(when.getHours()).padStart(2,'0')}:${String(when.getMinutes()).padStart(2,'0')}`;
      const dateStr = `${when.getFullYear()}-${String(when.getMonth()+1).padStart(2,'0')}-${String(when.getDate()).padStart(2,'0')}`;
      const timeStr = `${String(when.getHours()).padStart(2,'0')}:${String(when.getMinutes()).padStart(2,'0')}:${String(when.getSeconds()).padStart(2,'0')}`;

      const payload = {
        action: act,
        userId: profile.userId,
        lat: lastPos.coords.latitude,
        lng: lastPos.coords.longitude,
        accuracy: lastPos.coords.accuracy,
        device: navigator.userAgent || '',
        note: ''
      };

      // 嘗試後端（0.7 秒）
      let serverData = null;

  function pad2_(n){ return String(n).padStart(2,'0'); }
  function ymToDate_(ym){ // 'YYYY-MM'
    const [y,m] = ym.split('-').map(Number);
    return new Date(y, m-1, 1);
  }
  function dateKey_(d){
    return `${d.getFullYear()}-${pad2_(d.getMonth()+1)}-${pad2_(d.getDate())}`;
  }
  function isToday_(d){
    const now = new Date();
    return d.getFullYear()===now.getFullYear() && d.getMonth()===now.getMonth() && d.getDate()===now.getDate();
  }
  function firstDowMonday_(d){ // Monday=0..Sunday=6
    const js = d.getDay(); // Sun=0..Sat=6
    return (js + 6) % 7;
  }
  function renderCalendar_(month, items){
    // month: YYYY-MM ; items unused for cell display (detail uses map)
    const [yy, mm] = month.split('-').map(Number);
    const first = new Date(yy, mm-1, 1);
    const firstDow = (first.getDay() + 6) % 7; // Monday=0
    const daysInMonth = new Date(yy, mm, 0).getDate();

    const today = new Date();
    const todayKey = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

    const grid = document.getElementById('calendarGrid');
    if(!grid) return;
    grid.innerHTML = '';

    for(let i=0;i<42;i++){
      const dayNum = i - firstDow + 1;
      const inMonth = dayNum >= 1 && dayNum <= daysInMonth;
      const dateKey = inMonth ? `${yy}-${String(mm).padStart(2,'0')}-${String(dayNum).padStart(2,'0')}` : '';

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'cal-cell' + (inMonth ? '' : ' cal-out') + (dateKey===todayKey ? ' cal-today' : '');
      btn.disabled = !inMonth;
      btn.innerHTML = `<div class="cal-day">${inMonth ? dayNum : ''}</div>`;

      if(inMonth){
        btn.addEventListener('click', ()=> openDayDetail_(dateKey));
      }
      grid.appendChild(btn);
    }
}

    const first = ymToDate_(month);
    const y = first.getFullYear();
    const m = first.getMonth();
    const daysInMonth = new Date(y, m+1, 0).getDate();

    // previous month info
    const prevDays = new Date(y, m, 0).getDate();
    const startOffset = firstDowMonday_(first); // 0..6
    const totalCells = 42; // 6 weeks

    grid.innerHTML = '';

    function openDetail(dateKey, it){
      detailTitle.textContent = dateKey;
      const segs = (it && it.segments && it.segments.length)
        ? it.segments.map(s=>`${s.start}-${s.end}`).join('\n')
        : '—';
      const type = it ? it.type : 'OFF';
      const note = (it && it.note) ? it.note : '—';

      detailBody.innerHTML = `
        <div class="cal-detail-row"><div class="cal-detail-k">狀態</div><div class="cal-detail-v">${type}</div></div>
        <div class="cal-detail-row"><div class="cal-detail-k">時段</div><div class="cal-detail-v">${segs}</div></div>
        <div class="cal-detail-row"><div class="cal-detail-k">備註</div><div class="cal-detail-v">${note}</div></div>
      `;
      detail.classList.remove('hidden');
    }

    detailClose.onclick = ()=> detail.classList.add('hidden');
    detail.onclick = (e)=>{ if(e.target===detail) detail.classList.add('hidden'); };

    for(let i=0;i<totalCells;i++){
      let cellDate;
      let isOut=false;

      if(i < startOffset){
        const day = prevDays - (startOffset - 1 - i);
        cellDate = new Date(y, m-1, day);
        isOut = true;
      }else if(i >= startOffset + daysInMonth){
        const day = i - (startOffset + daysInMonth) + 1;
        cellDate = new Date(y, m+1, day);
        isOut = true;
      }else{
        const day = i - startOffset + 1;
        cellDate = new Date(y, m, day);
      }

      const key = dateKey_(cellDate);
      const it = map.get(key);

      const type = it ? it.type : (isOut ? '' : 'OFF');
      const seg0 = (it && it.segments && it.segments.length) ? `${it.segments[0].start}-${it.segments[0].end}` : '';
      const badgeTxt = (type==='WORK') ? '上班' : (type==='LEAVE' ? '請假' : (type==='OFF' ? '休' : ''));
      const badgeCls = (type==='WORK') ? 'work' : (type==='LEAVE' ? 'off' : 'off');

      const cell = document.createElement('div');
      cell.className = 'cal-cell' + (isOut ? ' is-out' : '') + (isToday_(cellDate) ? ' today' : '');
      cell.innerHTML = `
        <div class="cal-day">${cellDate.getDate()}</div>
        ${badgeTxt ? `<div class="cal-badge ${badgeCls}">${badgeTxt}</div>` : ``}
        ${seg0 ? `<div class="cal-time">${seg0}</div>` : ``}
      `;
      if(!isOut){
        cell.onclick = ()=> openDetail(key, it || {type:'OFF',segments:[],note:''});
      }
      grid.appendChild(cell);
    }
  }

async function loadSchedule(month){
  try{
    setScheduleStatus('', '載入中…');

    // 先用快取（秒開）
    const cached = loadCachedSchedule_(month);
    if(cached){
      window.__scheduleMap = cached.map || {};
      setScheduleStatus('ok', `✅ ${month} 班表`);
      renderCalendar_(month, []);
      return;
    }

    const resp = await fetch('/api/schedule', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ userId: profile.userId, month })
    });

    const data = await resp.json();
    if(!data || !data.ok){
      setScheduleStatus('bad', (data && data.message) ? data.message : '班表讀取失敗');
      return;
    }

    const map = {};
    const items = data.items || [];
    for(const it of items){
      if(it && it.date) map[it.date] = it;
    }

    window.__scheduleMap = map;
    saveCachedSchedule_(month, { map });

    setScheduleStatus('ok', `✅ ${month} 班表`);
    renderCalendar_(month, items);
  }catch(err){
    setScheduleStatus('bad', '班表載入失敗');
  }
}

  btnIn.addEventListener('click', ()=>postClock('IN'));
  btnOut.addEventListener('click', ()=>postClock('OUT'));

  btnCopyId.addEventListener('click', async ()=>{
    try{
      await navigator.clipboard.writeText(profile.userId);
      setStatus('ok','✅ 已複製 LINE ID，請貼到 Sheets employees');
    }catch(e){}
  });

  // ===== schedule（保留原功能）=====
  let currentMonth = (() => {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  })();

  
  // ===== Schedule cache (avoid long loading) =====
  const SCHEDULE_CACHE_TTL_MS = 5 * 60 * 1000; // 5 minutes

  function cacheKey_(month){ return `sched_${month}_${profile ? profile.userId : ''}`; }

  function loadCachedSchedule_(month){
    try{
      const key = cacheKey_(month);
      const raw = sessionStorage.getItem(key) || localStorage.getItem(key);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(!obj || !obj.ts || !obj.data) return null;
      if(Date.now() - obj.ts > SCHEDULE_CACHE_TTL_MS) return null;
      return obj.data;
    }catch(e){ return null; }
  }

  function saveCachedSchedule_(month, data){
    try{
      const key = cacheKey_(month);
      const obj = { ts: Date.now(), data };
      const raw = JSON.stringify(obj);
      sessionStorage.setItem(key, raw);
      try{ localStorage.setItem(key, raw); }catch(_){}
    }catch(e){}
  }
function changeMonth(delta){
    const [y,m] = currentMonth.split('-').map(Number);
    const d = new Date(y, m-1 + delta, 1);
    currentMonth = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    monthLabel.textContent = currentMonth;
    if(profile && profile.userId) loadSchedule(currentMonth);
  }
  btnPrev.addEventListener('click', ()=> changeMonth(-1));
  btnNext.addEventListener('click', ()=> changeMonth(1));

  function fmtSegs(segs){
    if(!segs || !segs.length) return '—';
    return segs.map(s=>`${s.start}-${s.end}`).join(' / ');
  }
  async function loadSchedule(month){
    try{
      setScheduleStatus('', '載入班表中…');
      scheduleList.innerHTML = '';
      const resp = await fetch('/api/schedule', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId: profile.userId, month })
      });
      const data = await resp.json();
      if(!data.ok){
        setScheduleStatus('bad', data.message || '班表讀取失敗');
        return;
      }
      setScheduleStatus('ok', `✅ 已載入 ${month} 班表`);
      const items = data.items || [];
      for(const it of items){
        const badgeCls = (it.type === 'WORK') ? 'badge work' : 'badge off';
        const badgeTxt = (it.type === 'WORK') ? '上班' : (it.type === 'LEAVE' ? '請假' : '休');
        const segTxt = fmtSegs(it.segments);
        const div = document.createElement('div');
        div.className='item';
        div.innerHTML = `
          <div>
            <div class="d">${it.date}</div>
            <div class="seg">${segTxt}</div>
            ${it.note ? `<div class="note">${it.note}</div>` : ``}
          </div>
          <div class="${badgeCls}">${badgeTxt}</div>
        `;
        scheduleList.appendChild(div);
      }
      if(items.length===0) setScheduleStatus('warn', '這個月沒有班表資料（或你尚未同步排班）');
    }catch(err){
      setScheduleStatus('bad', '班表載入失敗：' + (err && err.message ? err.message : err));
    }
  }

  // ===== init =====
  
  function openDayDetail_(dateKey){
    const map = window.__scheduleMap || {};
    const it = map[dateKey];

    const title = document.getElementById('dayTitle');
    const body = document.getElementById('dayBody');
    const sheet = document.getElementById('daySheet');
    if(!title || !body || !sheet) return;

    title.textContent = dateKey;

    if(!it){
      body.textContent = '無班表資料';
    }else{
      const type = it.type || 'WORK';
      const segs = (it.segments && it.segments.length) ? it.segments.map(s=>`${s.start}-${s.end}`).join(' / ') : '—';
      const note = it.note ? `\n備註：${it.note}` : '';
      const typeZh = (type==='WORK') ? '上班' : (type==='LEAVE' ? '請假' : '休');
      body.textContent = `狀態：${typeZh}\n時段：${segs}${note}`;
    }

    sheet.classList.remove('hidden');
  }

  function closeDayDetail_(){
    const sheet = document.getElementById('daySheet');
    if(sheet) sheet.classList.add('hidden');
  }

  document.addEventListener('click', (e)=>{
    const t = e.target;
    if(!t) return;
    if(t.id === 'dayClose') closeDayDetail_();
    if(t.id === 'daySheet') closeDayDetail_();
  });

async function init(){
    try{
      await liff.init({ liffId: LIFF_ID });

      try{
        clientText.textContent = (liff.isInClient && liff.isInClient()) ? 'LINE內（可關閉）' : '非LINE內（不可自動關閉）';
      }catch(e){ clientText.textContent='未知'; }

      if(!liff.isLoggedIn()){
        pillLogin.textContent='未登入';
        if(!liff.isInClient || !liff.isInClient()){
          setStatus('warn','請用 LINE 內開啟此頁面（LIFF）。');
          showCloseBtn();
          return;
        }
        setStatus('warn','請先登入 LINE 才能打卡。');
        liff.login(); return;
      }

      profile = await liff.getProfile();
      pillLogin.textContent='已登入';
      uidText.textContent = profile.userId || '--';

      // 優先用註冊名，不顯示 LINE 暱稱
      window.__empDisplayName = getEmpNameCached_();
      // 背景更新一次（不阻塞）
      fetchEmpDisplayName_(250).then(n=>{
        if(n){
          window.__empDisplayName = n;
          setEmpNameCached_(n);
          // 更新 hello 文案
          helloEl.textContent = `嗨 ${n}，請先取得定位後再打卡。`;
        }
      });

      helloEl.textContent = `嗨 ${(window.__empDisplayName || '員工')}，請先取得定位後再打卡。`;

      monthLabel.textContent = currentMonth;

      // ✅ 先開啟快速定位（不要等後端）
      getGpsFast();

      // ✅ 同步狀態（也會順便更新 display_name），不要卡住太久
      setStateUI('UNKNOWN');
      setStatus('', '讀取狀態中…');
      Promise.race([
        refreshState(),
        new Promise(res=>setTimeout(res, 450))
      ]).then(()=>{
        setStatus('ok', '狀態已更新，可以打卡。');
      });

      // Copy button
      btnCopyId.style.display = (profile.userId ? 'block' : 'none');

    }catch(err){
      setStatus('bad','初始化失敗：' + fmtErr_(err));
      showCloseBtn();
    }
  }

  init();
</script>

<script>
  // iOS Safari: prevent pinch zoom / gesture zoom
  document.addEventListener('gesturestart', function (e) { e.preventDefault(); }, { passive: false });
  document.addEventListener('gesturechange', function (e) { e.preventDefault(); }, { passive: false });
  document.addEventListener('gestureend', function (e) { e.preventDefault(); }, { passive: false });

  // prevent double-tap to zoom (best-effort)
  let lastTouchEnd = 0;
  document.addEventListener('touchend', function (e) {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
      e.preventDefault();
    }
    lastTouchEnd = now;
  }, { passive: false });
</script>
</body>
</html>
